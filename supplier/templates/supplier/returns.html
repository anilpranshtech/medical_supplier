{% extends 'supplier/base.html' %}
{% load static %}

{% block title %}
Supplier Returns
{% endblock title %}

{% block content %}

<div class="app-main flex-column flex-row-fluid" id="kt_app_main">
  <div class="d-flex flex-column flex-column-fluid">

    <div id="kt_app_content" class="app-content flex-column-fluid mx-5">
      <div id="kt_app_content_container" class="app-container container-fluid">

        <!-- Card -->
        <div class="card card-flush">
          <div class="card-header align-items-center py-5 gap-4">
            <h3 class="card-title">Supplier Returns</h3>
          </div>

          <div class="card-body table-responsive">
            <table id="kt_returns_table" class="table align-middle table-row-dashed fs-6 gy-5">
              <thead>
                <tr class="text-start text-gray-500 fw-bold fs-7 text-uppercase gs-0">
                  <th class="text-start min-w-150px ps-5">Return ID</th>
                  <th class="text-center min-w-150px">Product</th>
                  <th class="text-center min-w-100px">Customer</th>
                  <th class="text-center min-w-100px">Option</th>
                  <th class="text-center min-w-100px">Price</th>
                  <th class="text-center min-w-100px">Status</th>
                  <th class="text-center min-w-100px">Request Date</th>
                  <th class="text-center min-w-70px">Actions</th>
                </tr>
              </thead>
              <tbody class="fw-semibold text-gray-600">
                {% for return in returns %}
                <tr>
                  <!-- Return ID -->
                  <td class="text-start ps-5">
                    <span class="fw-bold">{{ return.return_serial }}</span>
                  </td>

                  <!-- Product -->
                  <td class="text-center">
                    <span class="fw-bold">{{ return.order_item.product.name }}</span>
                  </td>

                  <!-- Customer -->
                  <td class="text-center">
                    <span class="fw-bold">{{ return.client.username }}</span>
                  </td>

                  <!-- Option -->
                  <td class="text-center">
                    <span class="badge badge-light-info">{{ return.get_return_option_display }}</span>
                  </td>

                  <!-- Price -->
                  <td class="text-center">
                    {{ return.order_item.payment_currency|default:"USD" }} {{ return.price|floatformat:2 }}
                  </td>

                  <!-- Status -->
                  <td class="text-center">
                    {% if return.return_status == "pending" %}
                      <div class="badge badge-light-warning">Pending</div>
                    {% elif return.return_status == "approved" %}
                      <div class="badge badge-light-success">Approved</div>
                    {% elif return.return_status == "rejected" %}
                      <div class="badge badge-light-danger">Rejected</div>
                    {% else %}
                      <div class="badge badge-light">Unknown</div>
                    {% endif %}
                  </td>

                  <!-- Request Date -->
                  <td class="text-center">
                    <div class="badge badge-light fw-bold"
                      data-bs-toggle="tooltip"
                      title="{{ return.request_date|date:'F d Y P' }}">
                      {{ return.request_date|date:"d M, Y" }}
                    </div>
                  </td>

                  <!-- Actions Dropdown -->
                  <td class="text-center">
                    <a href="#"
                       class="btn btn-sm btn-light btn-flex btn-center btn-active-light-primary"
                       data-kt-menu-trigger="click"
                       data-kt-menu-placement="bottom-end">
                      Actions <i class="fas fa-angle-down fs-5 ms-1"></i>
                    </a>

                    <!-- Dropdown -->
                    <div class="menu menu-sub menu-sub-dropdown menu-column menu-rounded
                                menu-gray-600 menu-state-bg-light-primary fw-semibold fs-7 w-150px py-4"
                         data-kt-menu="true">

                      <!-- Update Status -->
                      <div class="menu-item px-3">
                        <a href="#" class="menu-link px-3" data-bs-toggle="modal" data-bs-target="#updateReturnModal{{ return.id }}">
                          Update Status
                        </a>
                      </div>
                    </div>
                  </td>
                </tr>

                <!-- Modal for Update Status -->
                <div class="modal fade" id="updateReturnModal{{ return.id }}" tabindex="-1" aria-hidden="true">
                  <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                      <form method="POST" action="{% url 'supplier:supplier_returns' return.return_serial %}">
                        {% csrf_token %}
                        <div class="modal-header">
                          <h5 class="modal-title">Update Return Status</h5>
                          <button type="button" class="btn btn-sm btn-icon" data-bs-dismiss="modal">
                            <i class="bi bi-x fs-2"></i>
                          </button>
                        </div>
                        <div class="modal-body">
                          <select name="return_status" class="form-select form-select-solid" data-hide-search="true" data-control="select2">
                            {% for status_value, status_label in return.RETURN_STATUS_CHOICES %}
                              <option value="{{ status_value }}" {% if return.return_status == status_value %}selected{% endif %}>
                                {{ status_label }}
                              </option>
                            {% endfor %}
                          </select>
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                          <button type="submit" class="btn btn-primary">Update</button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>

                {% empty %}
                <tr>
                  <td colspan="8" class="text-center text-gray-500">No return requests found.</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

      </div>
    </div>

  </div>
</div>
{% endblock content %}
