{% extends 'supplier/base.html' %}
{% load static %}
{% load superuser_tags %}
{% block title %}
Supplier Returns
{% endblock title %}
{% block content %}

{% tag_user_permissions_list request.user as user_permissions_list %}
<div class="app-main flex-column flex-row-fluid" id="kt_app_main">
  <div class="d-flex flex-column flex-column-fluid">
    <div id="kt_app_content" class="app-content flex-column-fluid mx-5">
      <div id="kt_app_content_container" class="app-container container-fluid">
        <!-- Filter Form -->
        <form action="{% url 'supplier:supplier_returns' %}" method="GET">
          <div class="card mb-7">
            <div class="card-body">
              <!-- Search and Sort Filters -->
              <div class="d-flex align-items-start flex-column search-card">
                <div class="d-flex flex-column flex-sm-row w-100 gap-5">
                  <!-- Search Input -->
                  <div class="position-relative w-md-400px me-md-2">
                    <i class="bi bi-search fs-3 text-gray-500 position-absolute top-50 translate-middle ms-6"></i>
                    <input type="text" class="form-control form-control-solid ps-10" name="search" value="{{ request.GET.search }}" placeholder="Search Returns" aria-label="Search Returns" />
                  </div>
                  <!-- Buttons and Sort -->
                  <div class="d-flex align-items-center">
                    <button type="submit" class="btn btn-primary me-3" aria-label="Search returns">Search</button>
                    {% if request.GET and request.GET.urlencode %}
                    <a href="{% url 'supplier:supplier_returns' %}" class="btn btn-primary me-3 mx-1">Clear Filters</a>
                    {% endif %}
                    <a href="#" class="btn btn-link me-3" data-bs-toggle="collapse" data-bs-target="#kt_advanced_search_form" aria-expanded="false" aria-controls="kt_advanced_search_form">Advanced Search</a>
                    <!-- Sort Dropdown -->
                  </div>
                </div>
                <small class="form-text text-muted">Choices: Return ID, Product, Customer</small>
              </div>
              <!-- Advanced Search Filters -->
              <div class="collapse" id="kt_advanced_search_form">
                <div class="separator separator-dashed mt-9 mb-6"></div>
                <div class="row g-8 mb-8">
                  <div class="col-xxl-12">
                    <div class="row g-8">
                      <!-- Product Filter -->
                      <div class="col-md-6 col-lg-6 col-xl-4 col-xxl-3">
                        <label class="fs-6 form-label fw-bold text-gray-900">Product</label>
                        <select class="form-select form-select-solid" data-control="select2" data-hide-search="true" name="product_filter">
                          <option value="all" {% if request.GET.product_filter == 'all' %}selected{% endif %}>All</option>
                          {% for product in products %}
                          <option value="{{ product.id }}" {% if request.GET.product_filter == product.id|stringformat:"s" %}selected{% endif %}>{{ product.name }}</option>
                          {% endfor %}
                        </select>
                      </div>
                      <!-- Return Option Filter -->
                      <div class="col-md-6 col-lg-6 col-xl-4 col-xxl-3">
                        <label class="fs-6 form-label fw-bold text-gray-900">Return Option</label>
                        <select class="form-select form-select-solid" data-control="select2" data-hide-search="true" name="return_option_filter">
                          <option value="all" {% if request.GET.return_option_filter == 'all' %}selected{% endif %}>All</option>
                          {% for option_value, option_label in return_option_choices %}
                          <option value="{{ option_value }}" {% if request.GET.return_option_filter == option_value %}selected{% endif %}>{{ option_label }}</option>
                          {% endfor %}
                        </select>
                      </div>
                      <!-- Return Status Filter -->
                      <div class="col-md-6 col-lg-6 col-xl-4 col-xxl-3">
                        <label class="fs-6 form-label fw-bold text-gray-900">Return Status</label>
                        <select class="form-select form-select-solid" data-control="select2" data-hide-search="true" name="return_status_filter">
                          <option value="all" {% if request.GET.return_status_filter == 'all' %}selected{% endif %}>All</option>
                          {% for status_value, status_label in return_status_choices %}
                          <option value="{{ status_value }}" {% if request.GET.return_status_filter == status_value %}selected{% endif %}>{{ status_label }}</option>
                          {% endfor %}
                        </select>
                      </div>
                   </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </form>
        <!-- Returns Table -->
        <div class="card card-flush">
          <div class="card-body table-responsive">
            <table id="kt_returns_table" class="table align-middle table-row-dashed fs-6 gy-5">
              <thead>
                <tr class="text-start text-gray-500 fw-bold fs-7 text-uppercase gs-0">
                  <th class="text-start min-w-150px ps-5">Return ID</th>
                  <th class="text-center min-w-150px">Product</th>
                  <th class="text-center min-w-100px">Customer</th>
                  <th class="text-center min-w-100px">Option</th>
                  <th class="text-center min-w-100px">Price</th>
                  <th class="text-center min-w-100px">Status</th>
                  <th class="text-center min-w-100px">Request Date</th>
                  {% if "dashboard.change_return" in user_permissions_list %}
                  <th class="text-center min-w-70px">Actions</th>
                  {% endif %}
                </tr>
              </thead>
              <tbody class="fw-semibold text-gray-600">
                {% for return in returns %}
                <tr>
                  <!-- Return ID -->
                  <td class="text-start ps-5">
                    <span class="fw-bold">{{ return.return_serial|default:'---' }}</span>
                  </td>
                  <!-- Product -->
                  <td class="text-center">
                    <div class="d-flex align-items-center justify-content-center">
                      <div class="ms-5">
                        <span class="fw-bold text-gray-800 text-hover-primary">{{ return.order_item.product.name|default:'---' }}</span>
                      </div>
                    </div>
                  </td>
                  <!-- Customer -->
                  <td class="text-center">
                    <span class="fw-bold">{{ return.client.username|default:'---' }}</span>
                  </td>
                  <!-- Option -->
                  <td class="text-center">
                    <span class="badge badge-light-info">{{ return.get_return_option_display|default:'---' }}</span>
                  </td>
                  <!-- Price -->
                  <td class="text-center">
                    <span class="text-success">{{ return.order_item.payment_currency|default:'USD' }} {{ return.price|floatformat:2|default:'---' }}</span>
                  </td>
                  <!-- Status -->
                  <td class="text-center">
                    {% if return.return_status == "pending" %}
                    <div class="badge badge-light-warning">Pending</div>
                    {% elif return.return_status == "replace_completed" %}
                    <div class="badge badge-light-success">Replace Completed</div>
                    {% elif return.return_status == "return_completed" %}
                    <div class="badge badge-light-success">Return Completed</div>
                    {% elif return.return_status == "cancelled" %}
                    <div class="badge badge-light-danger">Cancelled</div>
                    {% else %}
                    <div class="badge badge-light">Unknown</div>
                    {% endif %}
                  </td>
                  <!-- Request Date -->
                  <td class="text-center">
                    <div class="badge badge-light fw-bold" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ return.request_date|date:'F d Y P' }}">
                      {{ return.request_date|date:'F d Y'|default:'---' }}
                    </div>
                  </td>
                  <!-- Actions -->
                  {% if "dashboard.change_return" in user_permissions_list %}
                  <td class="text-center">
                    <a href="#" class="btn btn-sm btn-light btn-flex btn-center btn-active-light-primary" data-kt-menu-trigger="click" data-kt-menu-placement="bottom-end" aria-label="Return actions">
                      Actions <i class="fas fa-angle-down fs-5 ms-1"></i>
                    </a>
                    <div class="menu menu-sub menu-sub-dropdown menu-column menu-rounded menu-gray-600 menu-state-bg-light-primary fw-semibold fs-7 w-150px py-4" data-kt-menu="true">
                      <div class="menu-item px-3">
                        <a href="#" class="menu-link px-3" data-bs-toggle="modal" data-bs-target="#updateReturnModal{{ return.id }}">Update Status</a>
                      </div>
                    </div>
                  </td>
                  {% endif %}
                </tr>
                <!-- Modal for Update Status -->
                <div class="modal fade" id="updateReturnModal{{ return.id }}" tabindex="-1" aria-labelledby="updateReturnModalLabel{{ return.id }}" aria-hidden="true">
                  <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                      <form method="POST" action="{% url 'supplier:supplier_returns' return.return_serial %}">
                        {% csrf_token %}
                        <div class="modal-header">
                          <h5 class="modal-title" id="updateReturnModalLabel{{ return.id }}">Update Return Status</h5>
                          <button type="button" class="btn btn-sm btn-icon" data-bs-dismiss="modal" aria-label="Close">
                            <i class="bi bi-x fs-2"></i>
                          </button>
                        </div>
                        <div class="modal-body">
                          <select name="return_status" class="form-select form-select-solid" data-control="select2" data-hide-search="true" aria-label="Select return status">
                            {% for status_value, status_label in return_status_choices %}
                            <option value="{{ status_value }}" {% if return.return_status == status_value %}selected{% endif %}>{{ status_label }}</option>
                            {% endfor %}
                          </select>
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                          <button type="submit" class="btn btn-primary">Update Status</button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
                {% empty %}
                <tr>
                  <td colspan="{% if 'dashboard.change_return' in user_permissions_list %}8{% else %}7{% endif %}" class="text-center text-gray-500">No return requests found.</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
        {% include "supplier/pagination.html" %}
      </div>
    </div>
  </div>
</div>
{% endblock content %}