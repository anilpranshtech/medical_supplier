{% extends 'superuser/superuser_base.html' %}
{% load static %}

{% block title %}Top Supplier List{% endblock %}

{% block content %}
<div id="alertContainer" class="mt-3"></div>

<div class="app-main flex-column flex-row-fluid" id="kt_app_main">
  <div class="d-flex flex-column flex-column-fluid">
    <div id="kt_app_content" class="app-content flex-column-fluid mx-5">
      <div id="kt_app_content_container" class="app-container container-fluid">
        <div class="card card-flush">
          <div class="card-header flex-wrap align-items-center py-5 gap-4">
            <div class="card-title w-100 w-md-auto">
              <h4 class="fw-bold mb-0">Top Supplier List</h4>
            </div>
          </div>

          <div class="card-body pt-0 table-responsive">
            {% if top_suppliers %}
            <table class="table align-middle table-row-dashed fs-6 gy-5">
              <thead>
                <tr class="text-start text-gray-500 fw-bold fs-7 text-uppercase gs-0">
                  <th class="text-start ps-5">id</th>
                  <th class="text-start">Supplier Name</th>
                  <th class="text-center">Email</th>
                  <th class="text-center">Order</th>
                  <th class="text-center">Created At</th>
                  <th class="text-center">Action</th>
                </tr>
              </thead>
              <tbody class="fw-semibold text-gray-600">
                {% for item in top_suppliers %}
                <tr>
                  <td class="text-start ps-5">{{ forloop.counter }}</td>
                  <td class="text-start">{{ item.supplier.company_name }}</td>
                  <td class="text-center">{{ item.supplier.user.email }}</td>
                  <td class="text-center">{{ item.order }}</td>
                  <td class="text-center">{{ item.created_at|date:"Y-m-d H:i" }}</td>
                  <td class="text-center">
                    <button 
                      class="btn btn-sm btn-light-primary edit-btn" 
                      data-id="{{ item.id }}" 
                      data-supplier="{{ item.supplier.company_name }}" 
                      data-order="{{ item.order }}">
                      <i class="fas fa-edit"></i> Edit
                    </button>
                    <button 
                      class="btn btn-sm btn-light-danger delete-btn" 
                      data-id="{{ item.id }}">
                      <i class="fas fa-trash"></i> Delete
                    </button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
            {% else %}
            <p class="text-gray-500">No top suppliers found.</p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal fade" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Top Supplier</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="editForm" method="POST">
        {% csrf_token %}
        <div class="modal-body">
          <input type="hidden" id="editId" name="id">
          
          <div class="mb-3">
            <label class="form-label">Supplier Name</label>
            <select id="editSupplier" name="supplier" class="form-select" required>
              <option value="">-- Select Supplier --</option>
              {% for supplier in all_suppliers %}
                <option value="{{ supplier.id }}">{{ supplier.company_name }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Order</label>
            <input type="text" id="editOrder" name="order" class="form-control" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const alertContainer = document.getElementById('alertContainer');

  function showAlert(message, type = 'success') {
    alertContainer.innerHTML = `
      <div class="alert alert-${type} alert-dismissible fade show" role="alert">
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    `;
    setTimeout(() => {
      const alert = bootstrap.Alert.getOrCreateInstance(document.querySelector('.alert'));
      alert.close();
    }, 2000);
  }

  // Edit Modal
  document.querySelectorAll('.edit-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      document.getElementById('editId').value = this.dataset.id;
      document.getElementById('editOrder').value = this.dataset.order;

      const supplierName = this.dataset.supplier;
      const supplierSelect = document.getElementById('editSupplier');
      [...supplierSelect.options].forEach(option => {
        option.selected = option.text.trim() === supplierName.trim();
      });

      new bootstrap.Modal(document.getElementById('editModal')).show();
    });
  });

  // Handle Edit Form Submission
  document.getElementById('editForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    fetch("{% url 'superuser:edit_top_supplier' %}", {
      method: 'POST',
      body: formData,
      headers: {'X-Requested-With': 'XMLHttpRequest'}
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        new bootstrap.Modal(document.getElementById('editModal')).hide();
        showAlert('Supplier updated successfully!', 'success');
        setTimeout(() => location.reload(), 1500);
      } else {
        showAlert('Error updating supplier.', 'danger');
      }
    });
  });

  //  Delete
  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      if (confirm('Are you sure you want to delete this supplier?')) {
        fetch("{% url 'superuser:delete_top_supplier' %}", {
          method: 'POST',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({id: this.dataset.id})
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            showAlert('Supplier deleted successfully!', 'success');
            setTimeout(() => location.reload(), 1500);
          } else {
            showAlert('Error deleting supplier.', 'danger');
          }
        });
      }
    });
  });
});
</script>
{% endblock %}
