{% extends 'superuser/superuser_base.html' %}
{% load static %}
{% load superuser_tags %}

{% block title %}Basket Promotions{% endblock %}

{% block content %}
{% tag_user_permissions_list request.user as user_permissions_list %}
<div id="alertBox" class="alert d-none mt-3" role="alert"></div>

<div class="app-main flex-column flex-row-fluid" id="kt_app_main">
  <div class="d-flex flex-column flex-column-fluid">
    <div id="kt_app_content" class="app-content flex-column-fluid mx-5">
      <div id="kt_app_content_container" class="app-container container-fluid">
         <!-- Filter Form -->
         <form action="{% url 'superuser:basket_promotion' %}" method="GET">
          <div class="card mb-7">
              <div class="card-body">
                 
                  {% include "superuser/pages/filters/filter_search_by.html" with show_advance_search_link=True search_help_text='Choices: Origin' search_placeholder_text='Search Categories' %}
                  
                  <div class="collapse" id="kt_advanced_search_form">
                      <div class="separator separator-dashed mt-9 mb-6"></div>
                      <div class="row g-8 mb-8">
                          <div class="col-xxl-12">
                              <div class="row g-8">
                                
                                  {% include "superuser/pages/filters/filter_created_date_range_picker.html" %}
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
          </div>
      </form>
        <!-- Card -->
        <div class="card card-flush">
          <div class="card-header flex-wrap align-items-center py-5 gap-4">
            <div class="card-title w-100 w-md-auto">Basket Promotions</div>
            <div class="card-toolbar">
              {% if "dashboard.add_basketpromotion" in user_permissions_list  %}
              <button class="btn btn-primary" id="addPromotionBtn">
                <i class="fas fa-plus me-2"></i>Add Promotion
              </button>
              {% endif %}
            </div>
          </div>

          <div class="card-body pt-0 table-responsive">
            {% if promotions %}
            <table class="table align-middle table-row-dashed fs-6 gy-5">
              <thead>
                <tr class="text-start text-gray-500 fw-bold fs-7 text-uppercase gs-0">
                  <th class="text-start min-w-100px">Type</th>
                  <th class="text-start min-w-150px">Supplier</th>
                  <th class="text-start min-w-150px">Product</th>
                  <th class="text-start min-w-150px">Title</th>
                  <th class="text-center min-w-120px">Time Limit</th>
                  <th class="text-center min-w-200px">Period</th>
                  <th class="text-center min-w-100px">Status</th>
                  <th class="text-center min-w-150px">Created</th>
                  {% if "dashboard.change_basketpromotion" in user_permissions_list or "dashboard.delete_basketpromotion" in user_permissions_list  %}
                  <th class="text-center min-w-100px">Actions</th>
                  {% endif %}
                </tr>
              </thead>
              <tbody class="fw-semibold text-gray-600">
                {% for promo in promotions %}
                <tr>
                  <td class="text-start">{{ promo.product_type|upper }}</td>
                  <td class="text-start">
                    {% for s in promo.supplier.all %}
                      {{ s.user.username }}{% if not forloop.last %}, {% endif %}
                    {% empty %}
                      <span class="text-muted">—</span>
                    {% endfor %}
                  </td>
                  <td class="text-start">
                    {% for p in promo.product.all %}
                      {{ p.name }}{% if not forloop.last %}, {% endif %}
                    {% empty %}
                      <span class="text-muted">—</span>
                    {% endfor %}
                  </td>
                  <td class="text-start text-truncate" style="max-width:180px;" title="{{ promo.title_en }}">
                    {{ promo.title_en|default:"—" }}
                  </td>
                  <td class="text-center">{{ promo.time_limit|default:"—" }}</td>
                  <td class="text-center">{{ promo.promotion_period }}</td>
                  <td class="text-center">
                    {% if promo.status == 'Active' %}
                      <span class="badge bg-success">Active</span>
                    {% else %}
                      <span class="badge bg-danger">Inactive</span>
                    {% endif %}
                  </td>
                  <td class="text-center">{{ promo.created_at|date:"d M Y H:i" }}</td>
                  <td class="text-center">
                    <div class="dropdown">
                        <button class="btn btn-sm btn-light btn-active-light-primary dropdown-toggle"
                                type="button" data-bs-toggle="dropdown">
                            Actions
                        </button>
                
                        <ul class="dropdown-menu">
                            <li>
                                <a href="#" class="dropdown-item edit-promo-btn" data-id="{{ promo.id }}">
                                    <i class="fas fa-edit me-2"></i>Edit
                                </a>
                            </li>
                
                            <li>
                                <a href="#" class="dropdown-item text-danger delete-promo-btn" data-id="{{ promo.id }}">
                                    <i class="fas fa-trash me-2"></i>Delete
                                </a>
                            </li>
                        </ul>
                    </div>
                </td>
                
                </tr>
                {% endfor %}
              </tbody>
            </table>
            {% else %}
            <p class="text-gray-500">No basket promotions found.</p>
            {% endif %}
          </div>
        </div>
        {% include "superuser/pages/pagination.html" with page_obj=page_obj %}
      </div>
    </div>
  </div>
</div>

<!-- ADD MODAL -->
<div id="promotionAddModal" class="modal fade" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content rounded-3 shadow">
      <div class="modal-header text-white">
        <h5 class="modal-title">Add Basket Promotion</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-4">
        <form id="addPromotionForm" enctype="multipart/form-data">
          {% csrf_token %}
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label fw-semibold">Product Type</label>
              <select name="product_type" class="form-select" required>
                <option value="">Select Type</option>
                <option value="b2b">B2B</option>
                <option value="b2c">B2C</option>
              </select>
            </div>
<div class="col-md-6">
  <label class="form-label fw-semibold">Supplier <span style="color: red;">*</span></label>
  {% if request.user.supplierprofile %}
    <input type="hidden" name="supplier" value="{{ request.user.supplierprofile.id }}">
    <input type="text" class="form-control" value="{{ request.user.supplierprofile.user.username }}" disabled>
  {% else %}
    <select name="supplier" class="form-select select2" multiple required data-placeholder="Select suppliers">
      {% for s in suppliers %}
        <option value="{{ s.id }}">{{ s.user.username }}</option>
      {% endfor %}
    </select>
  {% endif %}
</div>
<div class="col-md-6">
  <label class="form-label fw-semibold">Product <span style="color: red;">*</span></label>
  <select name="product" class="form-select select2" multiple required data-placeholder="Select products">
    {% for p in products %}
      <option value="{{ p.id }}">{{ p.name }}</option>
    {% endfor %}
  </select>
</div>
            <div class="col-md-6">
              <label class="form-label fw-semibold">Title (EN)</label>
              <input type="text" name="title_en" class="form-control" maxlength="255">
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold">Time Limit</label>
              <input type="text" name="time_limit" class="form-control" placeholder="e.g., 24 hours">
            </div>
            <div class="col-md-12">
              <label class="form-label fw-semibold">Description (EN)</label>
              <textarea name="description_en" class="form-control" rows="3"></textarea>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold">Main Image</label>
              <input type="file" name="main_image" class="form-control" accept="image/*">
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold">Start Date & Time</label>
              <input type="datetime-local" name="start_datetime" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold">End Date & Time</label>
              <input type="datetime-local" name="end_datetime" class="form-control" required>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="saveAddPromotionBtn" class="btn btn-primary ">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- EDIT MODAL -->
<div id="promotionEditModal" class="modal fade" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content rounded-3 shadow">
      <div class="modal-header text-white">
        <h5 class="modal-title">Edit Basket Promotion</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-4">
        <form id="editPromotionForm" enctype="multipart/form-data">
          {% csrf_token %}
          <input type="hidden" id="promoIdField" name="promo_id">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label fw-semibold">Product Type</label>
              <select name="product_type" id="productType" class="form-select" required>
                <option value="">Select Type</option>
                <option value="b2b">B2B</option>
                <option value="b2c">B2C</option>
              </select>
            </div>
<div class="col-md-6">
  <label class="form-label fw-semibold">Supplier <span style="color: red;">*</span></label>
  {% if request.user.supplierprofile %}
    <input type="hidden" name="supplier" id="supplierEditHidden" value="{{ request.user.supplierprofile.id }}">
    <input type="text" class="form-control" value="{{ request.user.supplierprofile.user.username }}" disabled>
  {% else %}
    <select name="supplier" id="supplierSelect" class="form-select select2" multiple required
            data-placeholder="Select suppliers">
      {% for s in suppliers %}
        <option value="{{ s.id }}">{{ s.user.username }}</option>
      {% endfor %}
    </select>
  {% endif %}
</div>
<div class="col-md-6">
  <label class="form-label fw-semibold">Product <span style="color: red;">*</span></label>
  <select name="product" id="productSelect" class="form-select select2" multiple required
          data-placeholder="Select products">
    {% for p in products %}
      <option value="{{ p.id }}">{{ p.name }}</option>
    {% endfor %}
  </select>
</div>
            <div class="col-md-6">
              <label class="form-label fw-semibold">Title (EN)</label>
              <input type="text" name="title_en" id="titleInput" class="form-control" maxlength="255">
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold">Time Limit</label>
              <input type="text" name="time_limit" id="timeLimitInput" class="form-control" placeholder="e.g., 24 hours">
            </div>
            <div class="col-md-12">
              <label class="form-label fw-semibold">Description (EN)</label>
              <textarea name="description_en" id="descInput" class="form-control" rows="3"></textarea>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold">Main Image</label>
              <input type="file" name="main_image" class="form-control" accept="image/*">
              <div id="currentImage" class="mt-2"></div>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold">Start Date & Time</label>
              <input type="datetime-local" name="start_datetime" id="startInput" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold">End Date & Time</label>
              <input type="datetime-local" name="end_datetime" id="endInput" class="form-control" required>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="saveEditPromotionBtn" class="btn btn-primary ">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- DELETE MODAL -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-3 shadow">
      <div class="modal-header  text-white">
        <h5 class="modal-title">Confirm Delete</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <p class="fs-6 fw-semibold text-gray-700 mb-0">Are you sure you want to delete this promotion?</p>
      </div>
      <div class="modal-footer justify-content-center">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="confirmDeleteBtn" class="btn btn-danger btn-with-loader">Delete</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block page_only_scripts %}
{% include "superuser/pages/filters/filter_created_date_range_picker_js.html" %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const addModal  = new bootstrap.Modal(document.getElementById('promotionAddModal'));
    const editModal = new bootstrap.Modal(document.getElementById('promotionEditModal'));
    const delModal  = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    const alertBox  = document.getElementById('alertBox');
  
    function showAlert(msg, type = 'success') {
      alertBox.textContent = msg;
      alertBox.className = `alert alert-${type} mt-3`;
      alertBox.classList.remove('d-none');
      setTimeout(() => alertBox.classList.add('d-none'), 3000);
    }
  
    // Show loader on button
    function showLoader(button) {
      button.disabled = true;
      button.dataset.originalText = button.innerHTML;
      button.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Loading...';
    }
  
    // Hide loader on button
    function hideLoader(button) {
      button.disabled = false;
      if (button.dataset.originalText) {
        button.innerHTML = button.dataset.originalText;
      }
    }
  
    function showFieldError(input, msg) {
      clearFieldError(input);
      const el = document.createElement('div');
      el.className = 'text-danger mt-1 small';
      el.textContent = msg;
      input.closest('.col-md-6, .col-md-12').appendChild(el);
    }
  
    function clearFieldError(input) {
      const parent = input.closest('.col-md-6, .col-md-12');
      if (!parent) return;
      parent.querySelectorAll('.text-danger.small').forEach(e => e.remove());
    }
  
    function clearAllErrors(form) {
      form.querySelectorAll('.text-danger.small').forEach(e => e.remove());
    }
  
    $('.select2').select2({ width: '100%', allowClear: true });
  
    // Open Add Modal
    document.getElementById('addPromotionBtn').addEventListener('click', () => {
      const form = document.getElementById('addPromotionForm');
      form.reset();
      $('.select2').val(null).trigger('change');
      clearAllErrors(form);
      addModal.show();
    });
  
    // Date Validation
    function validateDates(start, end) {
      const now = new Date();
      now.setSeconds(0, 0);
      const s = new Date(start.value);
      const e = new Date(end.value);
      let ok = true;
      clearFieldError(start); 
      clearFieldError(end);
  
      if (!start.value) { 
        showFieldError(start, 'Start Date & Time is required'); 
        ok = false; 
      } else if (s < now) { 
        showFieldError(start, 'Start Date & Time cannot be in the past'); 
        ok = false; 
      }
  
      if (!end.value) { 
        showFieldError(end, 'End Date & Time is required'); 
        ok = false; 
      } else if (e < now) { 
        showFieldError(end, 'End Date & Time cannot be in the past'); 
        ok = false; 
      }
  
      if (start.value && end.value && e <= s) { 
        showFieldError(end, 'End Date & Time must be after Start Date & Time'); 
        ok = false; 
      }
  
      return ok;
    }
  
    function validateForm(form) {
      let valid = true;
      clearAllErrors(form);
  
      const productType = form.querySelector('[name="product_type"]');
      const title       = form.querySelector('[name="title_en"]');
      const timeLimit   = form.querySelector('[name="time_limit"]');
      const desc        = form.querySelector('[name="description_en"]');
      const supplier    = $(form).find('[name="supplier"]');
      const product     = $(form).find('[name="product"]');
      const start       = form.querySelector('[name="start_datetime"]');
      const end         = form.querySelector('[name="end_datetime"]');
  
      // Product Type validation
      if (!productType.value) { 
        showFieldError(productType, 'Product Type is required'); 
        valid = false; 
      }
  
      // Title validation
      if (!title.value.trim()) { 
        showFieldError(title, 'Title is required'); 
        valid = false; 
      }
  
      // Time Limit validation
      if (!timeLimit.value.trim()) { 
        showFieldError(timeLimit, 'Time Limit is required'); 
        valid = false; 
      }
  
      // Description validation
      if (!desc.value.trim()) { 
        showFieldError(desc, 'Description is required'); 
        valid = false; 
      }
      const supplierHidden = form.querySelector('[name="supplier"][type="hidden"]');
      if (!supplierHidden) {
        if (!supplier.val() || supplier.val().length === 0) {
          const el = supplier.next('.select2');
          if (el.length) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'text-danger mt-1 small';
            errorDiv.textContent = 'Select at least one supplier';
            el.after(errorDiv);
          }
          valid = false;
        }
      }
  
      // Product validation
      if (!product.val() || product.val().length === 0) {
        const el = product.next('.select2');
        if (el.length) {
          const errorDiv = document.createElement('div');
          errorDiv.className = 'text-danger mt-1 small';
          errorDiv.textContent = 'Select at least one product';
          el.after(errorDiv);
        }
        valid = false;
      }
  
      // Date validation
      if (!validateDates(start, end)) {
        valid = false;
      }
  
      return valid;
    }
  
    // ADD Promotion
    document.getElementById('saveAddPromotionBtn').addEventListener('click', function() {
      const form = document.getElementById('addPromotionForm');
      const button = this;
      if (!validateForm(form)) return;
      showLoader(button);
  
      const fd = new FormData(form);
      const fmt = d => d.toLocaleDateString('en-GB', {day:'2-digit', month:'short', year:'numeric'});
      fd.append('promotion_period', `${fmt(new Date(fd.get('start_datetime')))} - ${fmt(new Date(fd.get('end_datetime')))}`);
  
      fetch("{% url 'superuser:add_basket_promotion' %}", {
        method: 'POST',
        headers: { 'X-CSRFToken': '{{ csrf_token }}' },
        body: fd
      })
      .then(r => r.json())
      .then(res => {
        hideLoader(button);
        if (res.success) {
          addModal.hide();
          showAlert('Promotion added successfully!', 'success');
          setTimeout(() => location.reload(), 1200);
        } else {
          showAlert(res.msg || 'Failed to save promotion', 'danger');
        }
      })
      .catch(() => {
        hideLoader(button);
        showAlert('Network error occurred', 'danger');
      });
    });
  
    // EDIT Promotion
    document.querySelectorAll('.edit-promo-btn').forEach(btn => {
      btn.addEventListener('click', function (e) {
        e.preventDefault();
        const id = this.dataset.id;
        const button = this;
        
        // Show loader on edit button
        showLoader(button);
  
        const form = document.getElementById('editPromotionForm');
        clearAllErrors(form);
        document.getElementById('promoIdField').value = id;
  
        fetch("{% url 'superuser:edit_basket_promotion' 0 %}".replace('0', id))
          .then(r => r.json())
          .then(res => {
            hideLoader(button);
            if (!res.success) {
              showAlert(res.msg || 'Failed to load promotion', 'danger');
              return;
            }
            const d = res.data;
  
            $('#productType').val(d.product_type);
            $('#titleInput').val(d.title_en);
            $('#timeLimitInput').val(d.time_limit);
            $('#descInput').val(d.description_en);
            $('#startInput').val(d.start_datetime);
            $('#endInput').val(d.end_datetime);
            if (document.getElementById('supplierSelect')) {
              $('#supplierSelect').val(d.supplier).trigger('change');
            }
  
            $('#productSelect').val(d.product).trigger('change');
  
            const imgDiv = document.getElementById('currentImage');
            if (d.main_image_url) {
              imgDiv.innerHTML = `<img src="${d.main_image_url}" class="img-fluid rounded mt-2" style="max-height:120px;">`;
            } else {
              imgDiv.innerHTML = '<small class="text-muted">No image uploaded</small>';
            }
  
            editModal.show();
          })
          .catch(() => {
            hideLoader(button);
            showAlert('Error loading promotion data', 'danger');
          });
      });
    });
  
    // SAVE EDIT
    document.getElementById('saveEditPromotionBtn').addEventListener('click', function() {
      const form = document.getElementById('editPromotionForm');
      const button = this;
      const id = document.getElementById('promoIdField').value;
      if (!validateForm(form)) return;
      showLoader(button);
  
      const fd = new FormData(form);
      const fmt = d => d.toLocaleDateString('en-GB', {day:'2-digit', month:'short', year:'numeric'});
      fd.append('promotion_period', `${fmt(new Date(fd.get('start_datetime')))} - ${fmt(new Date(fd.get('end_datetime')))}`);
  
      fetch("{% url 'superuser:edit_basket_promotion' 0 %}".replace('0', id), {
        method: 'POST',
        headers: { 'X-CSRFToken': '{{ csrf_token }}' },
        body: fd
      })
      .then(r => r.json())
      .then(res => {
        hideLoader(button);
        if (res.success) {
          editModal.hide();
          showAlert('Promotion updated successfully!', 'success');
          setTimeout(() => location.reload(), 1200);
        } else {
          showAlert(res.msg || 'Update failed', 'danger');
        }
      })
      .catch(() => {
        hideLoader(button);
        showAlert('Network error occurred', 'danger');
      });
    });
  
    // DELETE Promotion
    let deleteId = null;
    document.querySelectorAll('.delete-promo-btn').forEach(btn => {
      btn.addEventListener('click', e => {
        e.preventDefault();
        deleteId = btn.dataset.id;
        delModal.show();
      });
    });
  
    document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
      if (!deleteId) return;
  
      const button = this;
      showLoader(button);
  
      fetch("{% url 'superuser:delete_basket_promotion' 0 %}".replace('0', deleteId), {
        method: 'POST',
        headers: { 'X-CSRFToken': '{{ csrf_token }}' }
      })
      .then(r => r.json())
      .then(res => {
        hideLoader(button);
        delModal.hide();
        if (res.success) {
          showAlert('Promotion deleted successfully!', 'danger');
          setTimeout(() => location.reload(), 1000);
        } else {
          showAlert('Delete failed', 'danger');
        }
      })
      .catch(() => {
        hideLoader(button);
        delModal.hide();
        showAlert('Network error occurred', 'danger');
      });
    });
  });
  </script>
{% endblock %}