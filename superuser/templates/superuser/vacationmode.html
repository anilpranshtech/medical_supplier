{% extends 'superuser/superuser_base.html' %}
{% load static %}

{% block content %}

<div class="app-main flex-column flex-row-fluid" id="kt_app_main">
  <div class="d-flex flex-column flex-column-fluid">
    <div id="kt_app_content" class="app-content flex-column-fluid mx-5">
      <div id="kt_app_content_container" class="app-container container-fluid">

        <div class="card card-flush">
          <div class="card-header">
            <h3 class="card-title">Client Vacation Requests</h3>
          </div>

          <div class="card-body pt-0 table-responsive">
            {% if vacation_requests %}
            <table class="table align-middle border-0 table-row-dashed fs-6 gy-5">

              <thead>
                <tr class="text-gray-600 fw-bold text-uppercase fs-7">
                  <th class="ps-4">Name</th>
                  <th class="text-center">Email</th>
                  <th class="text-center">Type</th>
                  <th class="text-center">Reason</th>
                  <th class="text-center">From</th>
                  <th class="text-center">To</th>
                  <th class="text-center">Status</th>
                  <th class="text-center pe-4">Action</th>
                </tr>
              </thead>
              
              <tbody>
                {% for req in vacation_requests %}
                <tr id="row-{{ req.id }}">
                  <td class="ps-4 fw-semibold">{{ req.supplier.username }}</td>
                  <td class="text-center">{{ req.supplier.email }}</td>
                  <td class="text-center">
                    <span class="badge badge-light-primary">{{ req.type }}</span>
                  </td>
                  <td class="text-center">
                    {% if req.reason %}
                      <div class="text-truncate" style="max-width: 200px;" title="{{ req.reason }}">
                        {{ req.reason }}
                      </div>
                    {% else %}
                      <span class="text-muted">-</span>
                    {% endif %}
                  </td>
                  <td class="text-center">{{ req.from_date }}</td>
                  <td class="text-center">{{ req.to_date }}</td>
                  <td class="text-center">
                    <span class="badge 
                      {% if req.status == 'Approved' %} badge-light-success
                      {% elif req.status == 'Rejected' %} badge-light-danger
                      {% else %} badge-light-warning {% endif %} 
                      fs-7 px-3 py-2"
                      id="status-{{ req.id }}">
                      {{ req.status }}
                    </span>
                  </td>
                  <td class="text-center pe-4">
                    <div class="d-flex justify-content-center gap-2">
                      <button type="button" class="btn btn-sm btn-success action-btn"
                          data-id="{{ req.id }}" data-action="approve"
                          {% if req.status != 'Pending' %} disabled {% endif %}>
                          <i class="bi bi-check-circle me-1"></i>Approve
                      </button>
                      <button type="button" class="btn btn-sm btn-danger action-btn"
                          data-id="{{ req.id }}" data-action="reject"
                          {% if req.status != 'Pending' %} disabled {% endif %}>
                          <i class="bi bi-x-circle me-1"></i>Reject
                      </button>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
            {% else %}
            <div class="text-center py-10">
              <i class="bi bi-calendar-x text-gray-400 fs-2x mb-4"></i>
              <p class="text-gray-500 fs-5">No vacation requests found.</p>
            </div>
            {% endif %}
          </div>
        </div>

      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block page_only_scripts %}
<!-- Include Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const buttons = document.querySelectorAll(".action-btn");

  buttons.forEach((btn) => {
    btn.addEventListener("click", function () {
      const requestId = this.dataset.id;
      const action = this.dataset.action;
      const statusBadge = document.querySelector(`#status-${requestId}`);
      
      // Check if already processed
      if (statusBadge.textContent.trim() === 'Approved' || statusBadge.textContent.trim() === 'Rejected') {
        Swal.fire({
          icon: 'info',
          title: 'Already Processed',
          text: 'This request has already been processed.',
          confirmButtonColor: '#4f46e5',
        });
        return;
      }

      // Show confirmation dialog
      Swal.fire({
        title: `Are you sure you want to ${action} this request?`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: action === 'approve' ? '#198754' : '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: `Yes, ${action}`,
        cancelButtonText: 'Cancel'
      }).then((result) => {
        if (result.isConfirmed) {
          fetch("", {
            method: "POST",
            headers: {
              "X-CSRFToken": "{{ csrf_token }}",
              "Content-Type": "application/x-www-form-urlencoded",
            },
            body: new URLSearchParams({
              request_id: requestId,
              action: action,
            }),
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              // Update status badge
              const newStatus = action.charAt(0).toUpperCase() + action.slice(1);
              statusBadge.textContent = newStatus;
              
              if (action === 'approve') {
                statusBadge.className = "badge badge-light-success fs-7 px-3 py-2";
              } else {
                statusBadge.className = "badge badge-light-danger fs-7 px-3 py-2";
              }
              
              // Disable buttons
              const rowButtons = document.querySelectorAll(`#row-${requestId} .action-btn`);
              rowButtons.forEach(b => {
                b.disabled = true;
                b.classList.add('opacity-50');
              });
              
              Swal.fire({
                icon: 'success',
                title: 'Success',
                text: data.message,
                confirmButtonColor: '#4f46e5',
              });
            } else if (data.error) {
              Swal.fire({
                icon: 'error',
                title: 'Error',
                text: data.error,
                confirmButtonColor: '#4f46e5',
              });
            }
          })
          .catch(error => {
            Swal.fire({
              icon: 'error',
              title: 'Network Error',
              text: 'Something went wrong. Please try again.',
              confirmButtonColor: '#4f46e5',
            });
          });
        }
      });
    });
  });
});
</script>
{% endblock %}