{% extends 'superuser/superuser_base.html' %}
{% load static %}

{% block title %}Manage Banks{% endblock %}

{% block content %}

<div id="successMessage" class="alert alert-success d-none" style="font-size:16px;">
  <strong id="successText"></strong>
</div>

<div class="app-main flex-column flex-row-fluid">
  <div class="d-flex flex-column flex-column-fluid mx-5 pt-5">

    <div class="card card-flush">
      <div class="card-header justify-content-between">
        <h3 class="card-title">Banks</h3>
        <button class="btn btn-primary px-4" id="addBankBtn">
          <i class="fas fa-plus me-2"></i> Add Bank
      </button>
      
      </div>

      <div class="card-body">
        <table class="table table-row-dashed">
          <thead>
            <tr>
              <th>Name </th>
              <th class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for bank in banks %}
            <tr>
              <td>{{ bank.name }}</td>
              <td class="text-center">
                <button class="btn btn-sm btn-light-primary editBankBtn"
                        data-id="{{ bank.id }}">
                  Edit
                </button>

                <button class="btn btn-sm btn-light-danger deleteBankBtn"
                        data-id="{{ bank.id }}">
                  Delete
                </button>
              </td>
            </tr>
            {% empty %}
            <tr><td colspan="2">No banks found</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<!-- Add Bank Modal -->
<div class="modal fade" id="addBankModal">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header  text-white">
        <h5>Add Bank</h5>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="addBankForm">
            {% csrf_token %}
            <label class="fw-semibold">Bank Name <span style="color: red;">*</span></label>
            <input type="text" name="name" class="form-control" required>
            <div class="text-danger mt-1" id="addBankError" style="display:none;"></div>
          </form>
          
      </div>
      <div class="modal-footer">
        <button class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" id="saveAddBank">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Bank Modal -->
<div class="modal fade" id="editBankModal">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header  text-white">
        <h5>Edit Bank</h5>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="editBankForm">
            {% csrf_token %}
            <input type="hidden" name="id" id="editBankId">
            <label class="fw-semibold">Bank Name  <span style="color: red;">*</span></label>
            <input type="text" name="name" id="editBankName" class="form-control" required>
            <div class="text-danger mt-1" id="editBankError" style="display:none;"></div>
          </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" id="saveEditBank">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirm -->
<div class="modal fade" id="deleteBankModal">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5>Confirm Delete</h5>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        Are you sure you want to delete this bank?
      </div>
      <div class="modal-footer justify-content-center">
        <button class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-danger" id="confirmDeleteBank">Delete</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block page_only_scripts %}
<script>

function showSuccess(msg) {
    const box = document.getElementById("successMessage");
    const text = document.getElementById("successText");

    text.innerText = msg;
    box.classList.remove("d-none");

   
    setTimeout(() => {
        box.classList.add("d-none");
    }, 2000);
}

    const addModal = new bootstrap.Modal(document.getElementById("addBankModal"));
    const editModal = new bootstrap.Modal(document.getElementById("editBankModal"));
    const deleteModal = new bootstrap.Modal(document.getElementById("deleteBankModal"));
    
    let deleteBankId = null;
    
    
    document.getElementById("addBankBtn").onclick = () => {
      document.getElementById("addBankForm").reset();
      document.getElementById("addBankError").style.display = "none";
      document.querySelector("#addBankForm input[name='name']").classList.remove("is-invalid");
      addModal.show();
    };
    
   
    document.getElementById("saveAddBank").onclick = () => {
      const form = document.getElementById("addBankForm");
      const nameInput = form.name;
      const errorDiv = document.getElementById("addBankError");
      const name = nameInput.value.trim();
    
      if (!name) {
        nameInput.classList.add("is-invalid");
        errorDiv.innerText = "Bank Name is required.";
        errorDiv.style.display = "block";
        nameInput.focus();
        return;
      }
    
      nameInput.classList.remove("is-invalid");
      errorDiv.style.display = "none";
    
      const formData = new FormData(form);
      fetch("{% url 'superuser:bank_add' %}", {
        method: "POST",
        headers: { "X-CSRFToken": "{{ csrf_token }}" },
        body: formData
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          addModal.hide();
showSuccess("Bank added successfully!");

setTimeout(() => {
    location.reload();
}, 1000);

        } else {
          errorDiv.innerText = data.msg || "Something went wrong!";
          errorDiv.style.display = "block";
          nameInput.classList.add("is-invalid");
        }
      });
    };
  
    document.querySelectorAll(".editBankBtn").forEach(btn => {
      btn.onclick = function () {
        const id = this.dataset.id;
        fetch(`/superuser/banks/get/${id}/`)
        .then(r => r.json())
        .then(res => {
          if(res.success){
            const nameInput = document.getElementById("editBankName");
            const errorDiv = document.getElementById("editBankError");
    
            document.getElementById("editBankId").value = res.data.id;
            nameInput.value = res.data.name;
            errorDiv.style.display = "none";
            nameInput.classList.remove("is-invalid");
    
            editModal.show();
          }
        });
      };
    });
    
   
    document.getElementById("saveEditBank").onclick = () => {
      const form = document.getElementById("editBankForm");
      const nameInput = form.name;
      const errorDiv = document.getElementById("editBankError");
      const name = nameInput.value.trim();
    
      if (!name) {
        nameInput.classList.add("is-invalid");
        errorDiv.innerText = "Bank Name is required.";
        errorDiv.style.display = "block";
        nameInput.focus();
        return;
      }
    
      nameInput.classList.remove("is-invalid");
      errorDiv.style.display = "none";
    
      const id = document.getElementById("editBankId").value;
      const formData = new FormData(form);
    
      fetch(`/superuser/banks/edit/${id}/`, {
        method: "POST",
        headers: { "X-CSRFToken": "{{ csrf_token }}" },
        body: formData
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          editModal.hide();
showSuccess(" Bank updated successfully!");

setTimeout(() => {
    location.reload();
}, 1000);

        } else {
          errorDiv.innerText = data.msg || "Something went wrong!";
          errorDiv.style.display = "block";
          nameInput.classList.add("is-invalid");
        }
      });
    };
    
   
    document.querySelectorAll(".deleteBankBtn").forEach(btn => {
      btn.onclick = function () {
        deleteBankId = this.dataset.id;
        deleteModal.show();
      };
    });
    
  
    document.getElementById("confirmDeleteBank").onclick = () => {
      fetch(`/superuser/banks/delete/${deleteBankId}/`, {
        method: "POST",
        headers: { "X-CSRFToken": "{{ csrf_token }}" }
      })
      .then(r => r.json())
      .then(res => {
        if (res.success) {
          deleteModal.hide();
showSuccess(" Bank deleted successfully!");

setTimeout(() => {
    location.reload();
}, 1000);

        } else {
          alert(res.msg || "Failed to delete!");
        }
      });
    };
    </script>
    
{% endblock %}
