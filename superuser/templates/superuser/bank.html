{% extends 'superuser/superuser_base.html' %}
{% load static %}

{% block title %}Manage Banks{% endblock %}

{% block content %}

<!-- Success Message -->
<div id="successMessage" class="alert alert-success d-none" style="font-size:16px;">
    <strong id="successText"></strong>
</div>

<div class="app-main flex-column flex-row-fluid">
<div class="d-flex flex-column flex-column-fluid mx-5 pt-5">

   <!-- Filter Form -->
   <form action="{% url 'superuser:banks' %}" method="GET">
    <div class="card mb-7">
        <div class="card-body">
            {% include "superuser/pages/filters/filter_sort_by.html" %}
            {% include "superuser/pages/filters/filter_search_by.html" with show_advance_search_link=True search_help_text='Choices: Bank Name' search_placeholder_text='Search bank' %}
            <div class="collapse" id="kt_advanced_search_form">
                <div class="separator separator-dashed mt-9 mb-6"></div>
                <div class="row g-8 mb-8">
                    <div class="col-xxl-12">
                        <div class="row g-8">
                            {% include "superuser/pages/filters/filter_created_date_range_picker.html" %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

    <!-- BANK TABLE -->
    <div class="card card-flush">
        <div class="card-header justify-content-between">
            <h3 class="card-title">Banks</h3>
            <button class="btn btn-primary px-4" id="addBankBtn">
                <i class="fas fa-plus me-2"></i> Add Bank
            </button>
        </div>

        <div class="card-body table-responsive">

            <table class="table table-row-dashed align-middle fs-6 gy-5" style="width: 100%;">
                <thead>
                <tr class="text-gray-500 fw-bold fs-7 text-uppercase" style="text-align: center;">
                    <th style="width:50%; padding: 12px;">Bank Name </th>
                    <th style=" padding: 12px;">Created at</th>
                    <th style="width:50%; padding: 12px;"> Actions </th>
                </tr>
                </thead>

                <tbody class="fw-semibold text-gray-600 text-center">
                {% for bank in banks %}
                <tr>
                    <td>{{ bank.name }}</td>
                     <td class="text-center">
                        <div class="badge badge-light fw-bold" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ bank.created_at|date:'F d Y P' }}">
                            {{ bank.created_at|date:'F d Y' | default:'No date found' }}
                        </div>
                    </td>
  
                    <td>
                        <!-- Actions Dropdown -->
                        <div class="dropdown">
                            <button class="btn btn-light-primary btn-sm dropdown-toggle" type="button" id="bankActionsDropdown{{ bank.id }}" data-bs-toggle="dropdown" aria-expanded="false">
                                Actions
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="bankActionsDropdown{{ bank.id }}">
                                <li>
                                    <a class="dropdown-item editBankBtn" href="javascript:void(0);" data-id="{{ bank.id }}">
                                        Edit
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item deleteBankBtn" href="javascript:void(0);" data-id="{{ bank.id }}">
                                        Delete
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="3" class="text-muted">No banks found</td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>

    </div>
    {% include "superuser/pages/pagination.html" %}

</div>
</div>

<!-- Add Bank Modal -->
<div class="modal fade" id="addBankModal">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header text-white">
        <h5>Add Bank</h5>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="addBankForm">
            {% csrf_token %}
            <label class="fw-semibold">Bank Name <span class="text-danger">*</span></label>
            <input type="text" name="name" class="form-control" required>
            <div class="text-danger mt-1" id="addBankError" style="display:none;"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" id="saveAddBank">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Bank Modal -->
<div class="modal fade" id="editBankModal">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header text-white">
        <h5>Edit Bank</h5>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="editBankForm">
            {% csrf_token %}
            <input type="hidden" id="editBankId" name="id">
            <label class="fw-semibold">Bank Name <span class="text-danger">*</span></label>
            <input type="text" name="name" id="editBankName" class="form-control" required>
            <div class="text-danger mt-1" id="editBankError" style="display:none;"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" id="saveEditBank">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirm Modal -->
<div class="modal fade" id="deleteBankModal">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5>Confirm Delete</h5>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        Are you sure you want to delete this bank?
      </div>
      <div class="modal-footer justify-content-center">
        <button class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-danger" id="confirmDeleteBank">Delete</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}


{% block page_only_scripts %}
{% include "superuser/pages/filters/filter_created_date_range_picker_js.html" %}

<script>
function showSuccess(msg) {
    const box = document.getElementById("successMessage");
    const text = document.getElementById("successText");
    text.innerText = msg;
    box.classList.remove("d-none");
    setTimeout(() => box.classList.add("d-none"), 2000);
}

const addModal = new bootstrap.Modal(document.getElementById("addBankModal"));
const editModal = new bootstrap.Modal(document.getElementById("editBankModal"));
const deleteModal = new bootstrap.Modal(document.getElementById("deleteBankModal"));

let deleteBankId = null;

document.getElementById("addBankBtn").onclick = () => {
    document.getElementById("addBankForm").reset();
    document.getElementById("addBankError").style.display = "none";
    addModal.show();
};

document.getElementById("saveAddBank").onclick = () => {
    const form = document.getElementById("addBankForm");
    const nameInput = form.name;
    const errorDiv = document.getElementById("addBankError");

    if (!nameInput.value.trim()) {
        errorDiv.innerText = "Bank Name is required.";
        errorDiv.style.display = "block";
        return;
    }

    fetch("{% url 'superuser:bank_add' %}", {
        method: "POST",
        headers: { "X-CSRFToken": "{{ csrf_token }}" },
        body: new FormData(form)
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            addModal.hide();
            showSuccess("Bank added successfully!");
            setTimeout(() => location.reload(), 1000);
        } else {
            errorDiv.innerText = data.msg;
            errorDiv.style.display = "block";
        }
    });
};

document.querySelectorAll(".editBankBtn").forEach(btn => {
    btn.onclick = () => {
        const id = btn.dataset.id;
        fetch("{% url 'superuser:bank_get' 0 %}".replace("/0/", `/${id}/`))
        .then(r => r.json())
        .then(res => {
            if (res.success) {
                document.getElementById("editBankId").value = res.data.id;
                document.getElementById("editBankName").value = res.data.name;
                editModal.show();
            }
        });
    };
});

document.getElementById("saveEditBank").onclick = () => {
    const form = document.getElementById("editBankForm");
    const errorDiv = document.getElementById("editBankError");
    const id = document.getElementById("editBankId").value;

    fetch("{% url 'superuser:bank_edit' 0 %}".replace("/0/", `/${id}/`), {
        method: "POST",
        headers: { "X-CSRFToken": "{{ csrf_token }}" },
        body: new FormData(form)
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            editModal.hide();
            showSuccess("Bank updated successfully!");
            setTimeout(() => location.reload(), 1000);
        } else {
            errorDiv.innerText = data.msg;
            errorDiv.style.display = "block";
        }
    });
};

document.querySelectorAll(".deleteBankBtn").forEach(btn => {
    btn.onclick = () => {
        deleteBankId = btn.dataset.id;
        deleteModal.show();
    };
});

document.getElementById("confirmDeleteBank").onclick = () => {
    fetch("{% url 'superuser:bank_delete' 0 %}".replace("/0/", `/${deleteBankId}/`), {
        method: "POST",
        headers: { "X-CSRFToken": "{{ csrf_token }}" }
    })
    .then(r => r.json())
    .then(res => {
        if (res.success) {
            deleteModal.hide();
            showSuccess("Bank deleted successfully!");
            setTimeout(() => location.reload(), 1000);
        }
    });
};
</script>
{% endblock %}
