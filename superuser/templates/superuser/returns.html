{% extends 'superuser/superuser_base.html' %}
{% load static %}
{% load custom_filters %}
{% load tz %}

{% block content %}
<div class="app-main flex-column flex-row-fluid" id="kt_app_main">
  <div class="d-flex flex-column flex-column-fluid">
    <div id="kt_app_content" class="app-content flex-column-fluid mx-5">
      <div id="kt_app_content_container" class="app-container container-fluid">

        <!-- === Count Summary === -->
        <div class="row text-center mb-3 mt-3">
          <div class="col-12 col-md-3 mb-4">
            <div class="card h-100 py-4">
              <div class="fw-bolder text-primary">ALL RETURNS</div>
              <div class="card-count text-primary fw-bolder">{{ count_all }}</div>
            </div>
          </div>
          <div class="col-12 col-md-3 mb-4">
            <div class="card h-100 py-4">
              <div class="fw-bolder text-success">APPROVED</div>
              <div class="card-count text-success fw-bolder">{{ count_approved }}</div>
            </div>
          </div>
          <div class="col-12 col-md-3 mb-4">
            <div class="card h-100 py-4">
              <div class="fw-bolder text-warning">PENDING</div>
              <div class="card-count text-warning fw-bolder">{{ count_pending }}</div>
            </div>
          </div>
          <div class="col-12 col-md-3 mb-4">
            <div class="card h-100 py-4">
              <div class="fw-bolder text-danger">REJECTED</div>
              <div class="card-count text-danger fw-bolder">{{ count_rejected }}</div>
            </div>
          </div>
        </div>

        <!-- === Returns Table === -->
        <div class="card card-flush mb-3">
          <div class="card-body table-responsive mx-5">
            <table class="table align-middle table-row-dashed fs-6 gy-5 px-0 text-center">
              <thead>
                <tr class="text-gray-500 fw-bold fs-7 text-uppercase gs-0 text-center">
                  <th>Return ID</th>
                  <th>Product</th>
                  <th>Customer</th>
                  <th>Return Option</th>
                  <th>Status</th>
                  <th>Price</th>
                  <th>Order ID</th>
                  <th>Supplier</th>
                  <th>Request Date</th>
                  <th>Actions</th>
                </tr>
              </thead>

              <tbody class="fw-semibold text-gray-600 text-center">
                {% for return in returns %}
                <tr>
                  <td>{{ return.return_serial }}</td>
                  <td>{{ return.order_item.product.name }}</td>
                  <td>{{ return.client.username }}</td>
                  <td>{{ return.get_return_option_display }}</td>
                  <td>
                    {% if return.return_status == "approved" %}
                      <div class="badge badge-light-success">{{ return.get_return_status_display }}</div>
                    {% elif return.return_status == "pending" %}
                      <div class="badge badge-light-warning">{{ return.get_return_status_display }}</div>
                    {% else %}
                      <div class="badge badge-light-danger">{{ return.get_return_status_display }}</div>
                    {% endif %}
                  </td>
                  <td>{{ return.order_item.payment_currency|default:"USD" }} {{ return.price|floatformat:2 }}</td>
                  <td>{{ return.order_item.order.order_id }}</td>
                  <td>{{ return.order_item.product.brand.supplier.username|default:"N/A" }}</td>
                  <td>{{ return.request_date|date:"d M, Y" }}</td>
                  <td class="text-center">
                    <!-- Actions Dropdown -->
                    <a href="#" class="btn btn-sm btn-light btn-flex btn-center btn-active-light-primary"
                       data-kt-menu-trigger="click" data-kt-menu-placement="bottom-end">
                      Actions <i class="fas fa-angle-down fs-5 ms-1"></i>
                    </a>

                    <!-- Dropdown Menu -->
                    <div class="menu menu-sub menu-sub-dropdown menu-column menu-rounded
                                menu-gray-600 menu-state-bg-light-primary fw-semibold fs-7 w-150px py-4"
                         data-kt-menu="true">

                      <!-- Update Status -->
                      <div class="menu-item px-3">
                        <a href="#" class="menu-link px-3"
                           data-bs-toggle="modal" data-bs-target="#updateReturnModal{{ return.id }}">
                          Update Status
                        </a>
                      </div>
                    </div>

                    <!-- Modal for Update Status -->
                    <div class="modal fade" id="updateReturnModal{{ return.id }}" tabindex="-1" aria-hidden="true">
                      <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                          <form method="POST" action="{% url 'superuser:admin_returns_update' return.return_serial %}">
                            {% csrf_token %}
                            <div class="modal-header">
                              <h5 class="modal-title">Update Return Status</h5>
                              <button type="button" class="btn btn-sm btn-icon" data-bs-dismiss="modal">
                                <i class="bi bi-x fs-2"></i>
                              </button>
                            </div>
                            <div class="modal-body">
                              <select name="return_status" class="form-select">
                                {% for status_value, status_label in return.RETURN_STATUS_CHOICES %}
                                  <option value="{{ status_value }}" {% if return.return_status == status_value %}selected{% endif %}>
                                    {{ status_label }}
                                  </option>
                                {% endfor %}
                              </select>
                            </div>
                            <div class="modal-footer">
                              <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                              <button type="submit" class="btn btn-primary">Update</button>
                            </div>
                          </form>
                        </div>
                      </div>
                    </div>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="10" class="text-center text-muted">No return requests found.</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        {% include "superuser/pages/pagination.html" %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
