{% extends 'superuser/superuser_base.html' %}
{% load static %}
{% load custom_filters %}
{% load tz %}

{% block extra_css_start %}
    <style>
        .modal-title {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .modal-footer .btn {
            padding: 0.75rem 1.5rem;
        }
        .form-control-lg, .form-select-lg {
            font-size: 1.1rem;
            padding: 0.5rem 1rem;
        }
        .form-check-label {
            font-size: 1rem;
        }
        .form-check {
            margin-bottom: 0.75rem;
        }
        .form-check-input {
            width: 1.25rem;
            height: 1.25rem;
        }
        .mb-4 {
            margin-bottom: 1.5rem !important;
        }
        .modal-lg {
            max-width: 900px;
        }
        .span_tag_highlight_credits {
            font-size: 11px;
            line-height: 1.3;
            max-width: 100%;
            display: inline-block;
            word-break: break-word;
        }
        #kt_table_refund_details td,
        #kt_table_refund_details th {
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
        }
    </style>
{% endblock extra_css_start %}

{% block content %}
<div class="app-main flex-column flex-row-fluid" id="kt_app_main">
  <div class="d-flex flex-column flex-column-fluid">
    <div id="kt_app_content" class="app-content flex-column-fluid mx-5">
      <div id="kt_app_content_container" class="app-container container-fluid">

        <!-- === Count Summary === -->
        <div class="row text-center mb-3 mt-3">
          <div class="col-12 col-md-3 mb-4">
            <div class="card h-100 py-4">
              <div class="fw-bolder text-primary">ALL RETURNS</div>
              <div class="card-count text-primary fw-bolder">{{ count_all }}</div>
            </div>
          </div>
          <div class="col-12 col-md-3 mb-4">
            <div class="card h-100 py-4">
              <div class="fw-bolder text-success">APPROVED</div>
              <div class="card-count text-success fw-bolder">{{ count_approved }}</div>
            </div>
          </div>
          <div class="col-12 col-md-3 mb-4">
            <div class="card h-100 py-4">
              <div class="fw-bolder text-warning">PENDING</div>
              <div class="card-count text-warning fw-bolder">{{ count_pending }}</div>
            </div>
          </div>
          <div class="col-12 col-md-3 mb-4">
            <div class="card h-100 py-4">
              <div class="fw-bolder text-danger">REJECTED</div>
              <div class="card-count text-danger fw-bolder">{{ count_rejected }}</div>
            </div>
          </div>
        </div>

        <!-- === Returns Table === -->
        <div class="card card-flush mb-3">
          <div class="card-body table-responsive mx-5">
            <table class="table align-middle table-row-dashed fs-6 gy-5 px-0 text-center" id="kt_table_returns">
              <thead>
                <tr class="text-gray-500 fw-bold fs-7 text-uppercase gs-0 text-center">
                  <th>Return ID</th>
                  <th>Product</th>
                  <th>Customer</th>
                  <th>Return Option</th>
                  <th>Status</th>
                  <th>Price</th>
                  <th>Order ID</th>
                  <th>Supplier</th>
                  <th>Request Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody class="fw-semibold text-gray-600 text-center">
                {% for return in returns %}
                <tr>
                  <td>{{ return.return_serial }}</td>
                  <td>{{ return.order_item.product.name }}</td>
                  <td>{{ return.client.username }}</td>
                  <td>{{ return.get_return_option_display }}</td>
                  <td>
                    {% if return.return_status == "approved" %}
                      <div class="badge badge-light-success">{{ return.get_return_status_display }}</div>
                    {% elif return.return_status == "pending" %}
                      <div class="badge badge-light-warning">{{ return.get_return_status_display }}</div>
                    {% else %}
                      <div class="badge badge-light-danger">{{ return.get_return_status_display }}</div>
                    {% endif %}
                  </td>
                  <td>{{ return.order_item.payment_currency|default:"USD" }} {{ return.price|floatformat:2 }}</td>
                  <td>{{ return.order_item.order.order_id }}</td>
                  <td>{{ return.order_item.product.brand.supplier.username|default:"N/A" }}</td>
                  <td>{{ return.request_date|date:"d M, Y" }}</td>
                  <td class="text-center">
                    <!-- Actions Dropdown -->
                    <a href="#" class="btn btn-sm btn-light btn-flex btn-center btn-active-light-primary"
                       data-kt-menu-trigger="click" data-kt-menu-placement="bottom-end">
                      Actions <i class="fas fa-angle-down fs-5 ms-1"></i>
                    </a>

                    <!-- Dropdown Menu -->
                    <div class="menu menu-sub menu-sub-dropdown menu-column menu-rounded
                                menu-gray-600 menu-state-bg-light-primary fw-semibold fs-7 w-150px py-4"
                         data-kt-menu="true">
                      <!-- Update Status -->
                      <div class="menu-item px-3">
                        <a href="#" class="menu-link px-3"
                           data-bs-toggle="modal" data-bs-target="#updateReturnModal{{ return.id }}">
                          Update Status
                        </a>
                      </div>
                      <!-- Refund Action -->
                      {% if return.return_status == "approved" and not return.is_refunded %}
                      <div class="menu-item px-3">
                        <a href="#" class="menu-link px-3 notes_model_selector"
                           data-bs-toggle="modal" data-bs-target="#refundModal1"
                           data-transaction-id="{{ return.order_item.order.payment.customer_id }}"
                           data-transaction-amount="{{ return.price }}"
                           data-transaction-mode="refund">
                          Process Refund
                        </a>
                      </div>
                      {% endif %}
                      <!-- Refund Details -->
                      {% if return.is_refunded %}
                      <div class="menu-item px-3">
                        <a href="#" class="menu-link px-3"
                           data-bs-toggle="modal" data-bs-target="#refundDetailsModal{{ return.id }}">
                          Refund Details
                        </a>
                      </div>
                      {% endif %}
                      <!-- Delete Action -->
                      <div class="menu-item px-3">
                        <a href="#" class="menu-link px-3"
                           data-bs-toggle="modal" data-bs-target="#deleteReturnModal{{ return.id }}">
                          Delete
                        </a>
                      </div>
                    </div>

                    <!-- Modal for Update Status -->
                    <div class="modal fade" id="updateReturnModal{{ return.id }}" tabindex="-1" aria-hidden="true">
                      <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                          <form method="POST" action="{% url 'superuser:admin_returns_update' return.return_serial %}">
                            {% csrf_token %}
                            <div class="modal-header">
                              <h5 class="modal-title">Update Return Status</h5>
                              <button type="button" class="btn btn-sm btn-icon" data-bs-dismiss="modal">
                                <i class="bi bi-x fs-2"></i>
                              </button>
                            </div>
                            <div class="modal-body">
                              <select name="return_status" class="form-select form-select-solid" data-hide-search="true" data-control="select2">
                                {% for status_value, status_label in return.RETURN_STATUS_CHOICES %}
                                  <option value="{{ status_value }}" {% if return.return_status == status_value %}selected{% endif %}>
                                    {{ status_label }}
                                  </option>
                                {% endfor %}
                              </select>
                            </div>
                            <div class="modal-footer">
                              <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                              <button type="submit" class="btn btn-primary">Update</button>
                            </div>
                          </form>
                        </div>
                      </div>
                    </div>

                    <!-- Refund Reason Modal -->
                    <div class="modal fade" id="refundModal1" tabindex="-1" aria-labelledby="refundModalLabel1" aria-hidden="true">
                      <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                          <form method="post">
                            <div class="modal-header">
                              <h5 class="modal-title" id="refundModalLabel1">Refund</h5>
                              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body" style="text-align:left;">
                              <div class="mb-3">
                                <label for="adminNote" class="form-label">Admin Note <span style="color: red;">*</span></label>
                                <textarea class="form-control" id="adminNote" name="refund_reason" rows="4" placeholder="Notes from Admin" required></textarea>
                              </div>
                              <div class="mb-3">
                                <label for="userNote" class="form-label">User Note <span style="color: red;">*</span></label>
                                <textarea class="form-control" id="userNote" name="user_note" rows="4" required placeholder="Additional notes from user"></textarea>
                              </div>
                            </div>
                            <div class="modal-footer">
                              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                              <button type="button" class="btn btn-danger submit_button_model1">Submit</button>
                            </div>
                          </form>
                        </div>
                      </div>
                    </div>

                    <!-- Confirm Refund Modal -->
                    <div class="modal fade" id="refundModal2" tabindex="-1" aria-labelledby="refundModalLabel" aria-hidden="true">
                      <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                          <div class="modal-header">
                            <h5 class="modal-title" id="refundModalLabel">Confirm Refund</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                          </div>
                          <form method="POST" action="{% url 'superuser:stripe_refund' %}">
                            {% csrf_token %}
                            <div class="modal-body" style="text-align: left;">
                              <p class="mb-3 fw-semibold text-danger">⚠️ Do you really want to refund?</p>
                              <div class="form-check mb-2">
                                <input class="form-check-input" name="editAmountCheckbox" type="checkbox" id="editAmountCheckbox">
                                <label class="form-check-label" for="editAmountCheckbox">Edit Amount?</label>
                              </div>
                              <div class="mb-3" id="editAmountInput" style="display: none;">
                                <input type="number" name="final_refund_amount" class="form-control final_refund_amount" placeholder="Enter refund amount ($)">
                              </div>
                              <input hidden name="hidden_transaction_id" id="hidden_transaction_id" value="">
                              <input hidden name="hidden_transaction_amount" id="hidden_transaction_amount" value="">
                              <input hidden name="hidden_transaction_mode" id="hidden_transaction_mode" value="">
                              <input hidden name="hidden_admin_note" id="hidden_admin_note" value="">
                              <input hidden name="hidden_user_note" id="hidden_user_note" value="">
                            </div>
                            <div class="modal-footer">
                              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                              <button type="submit" class="btn btn-danger final_confirmations">Confirm Refund</button>
                            </div>
                          </form>
                        </div>
                      </div>
                    </div>

                    <!-- Refund Details Modal -->
                    <div class="modal fade" id="refundDetailsModal{{ return.id }}" tabindex="-1" aria-labelledby="refundDetailsModalLabel{{ return.id }}" aria-hidden="true">
                      <div class="modal-dialog modal-dialog-centered modal-lg">
                        <div class="modal-content">
                          <div class="modal-header">
                            <h5 class="modal-title" id="refundDetailsModalLabel{{ return.id }}">Refund Details</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                          </div>
                          <div class="modal-body text-start">
                            <div class="card-body pt-0">
                              <table class="table gy-5" id="kt_table_refund_details">
                                <tbody class="fs-6 fw-semibold text-gray-600">
                                  <tr>
                                    <td>User:</td>
                                    <td><span class="badge text-muted fs-6 text-wrap">{{ return.client.username }}</span></td>
                                  </tr>
                                  <tr>
                                    <td>Amount:</td>
                                    <td><span class="badge text-muted fs-6 text-wrap">{{ return.order_item.payment_currency|default:"USD" }} {{ return.price|floatformat:2 }}</span></td>
                                  </tr>
                                  <tr>
                                    <td>Mode:</td>
                                    <td><span class="badge text-muted fs-6 text-wrap">{{ return.transaction.payment_type }}</span></td>
                                  </tr>
                                  {% if return.transaction.refund_info %}
                                    <tr>
                                      <td>Refund ID:</td>
                                      <td>{{ return.transaction.refund_info.id }}</td>
                                    </tr>
                                    <tr>
                                      <td>Status:</td>
                                      <td>{{ return.transaction.refund_info.status }}</td>
                                    </tr>
                                    <tr>
                                      <td>Refunded Amount:</td>
                                      <td>{{ return.order_item.payment_currency|default:"USD" }} {{ return.transaction.refund_info.amount_dollars|floatformat:2 }}</td>
                                    </tr>
                                    <tr>
                                      <td>Charge ID:</td>
                                      <td>{{ return.transaction.refund_info.charge }}</td>
                                    </tr>
                                    <tr>
                                      <td>Currency:</td>
                                      <td>{{ return.transaction.refund_info.currency|upper }}</td>
                                    </tr>
                                    <tr>
                                      <td>Refunded By:</td>
                                      <td>{{ return.transaction.refund_info.metadata.refunded_by }}</td>
                                    </tr>
                                    <tr>
                                      <td>User Refund Notes:</td>
                                      <td>{{ return.transaction.refund_info.metadata.description }}</td>
                                    </tr>
                                    <tr>
                                      <td>Admin Refund Notes:</td>
                                      <td>{{ return.transaction.refund_info.metadata.admin_notes }}</td>
                                    </tr>
                                    <tr>
                                      <td>Refund At:</td>
                                      <td>{{ return.transaction.refund_info.created_formatted }}</td>
                                    </tr>
                                  {% else %}
                                    <tr>
                                      <td colspan="2"><em>No refund info available.</em></td>
                                    </tr>
                                  {% endif %}
                                </tbody>
                              </table>
                            </div>
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Delete Modal -->
                    <div class="modal fade" id="deleteReturnModal{{ return.id }}" tabindex="-1" aria-labelledby="deleteReturnModalLabel{{ return.id }}" aria-hidden="true">
                      <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                          <div class="modal-header">
                            <h5 class="modal-title" id="deleteReturnModalLabel{{ return.id }}">Confirm Deletion</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                          </div>
                          <div class="modal-body" style="text-align:left;">
                            Are you sure you want to delete return request {{ return.return_serial }}?
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <form method="post" action="{% url 'superuser:admin_returns_delete' return.return_serial %}">
                              {% csrf_token %}
                              <button type="submit" class="btn btn-danger">Delete</button>
                            </form>
                          </div>
                        </div>
                      </div>
                    </div>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="10" class="text-center text-muted">No return requests found.</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        {% include "superuser/pages/pagination.html" %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block page_only_scripts %}
<script>
$(document).ready(function() {
    function getCurrentAmount() {
        let transactionAmount = parseFloat($('#hidden_transaction_amount').val()) || 0;
        return transactionAmount;
    }

    $('#editAmountCheckbox').on('change', function() {
        if ($(this).is(':checked')) {
            $('.final_refund_amount').val('').val($('#hidden_transaction_amount').val());
            $('#editAmountInput').slideDown();
        } else {
            $('#editAmountInput').slideUp();
            $('.final_refund_amount').val('');
        }
    });

    $(document).on('click', '.notes_model_selector', function() {
        $('#hidden_transaction_id').val('').val($(this).attr('data-transaction-id'));
        $('#hidden_transaction_amount').val('').val($(this).attr('data-transaction-amount'));
        $('#hidden_transaction_mode').val('').val($(this).attr('data-transaction-mode'));
    });

    $(document).on('click', '.submit_button_model1', function() {
        const adminNote = $('#adminNote').val().trim();
        const userNote = $('#userNote').val().trim();
        if (!adminNote || !userNote) {
            alert('Please fill in both Admin Note and User Note before continuing.');
            return;
        }
        $('#hidden_admin_note').val('').val(adminNote);
        $('#hidden_user_note').val('').val(userNote);
        $('#refundModal1').modal('hide');
        $('#refundModal2').modal('show');
    });

    $('#refundModal2').on('hidden.bs.modal', function() {
        $(this).find('form')[0].reset();
        $('#editAmountInput').hide();
    });

    $('#refundModal1').on('hidden.bs.modal', function() {
        $(this).find('form')[0].reset();
    });

    $(document).on('input', '.final_refund_amount', function() {
        this.value = this.value.replace(/[^0-9.]/g, '');
        let enteredAmount = parseFloat($(this).val()) || 0;
        let chargedAmount = parseFloat($('#hidden_transaction_amount').val()) || 0;
        if (enteredAmount > chargedAmount) {
            alert('Amount cannot be greater than the charged amount');
            $(this).val('').val($('#hidden_transaction_amount').val());
        }
    });

    $(document).on('click', '.final_confirmations', function(e) {
        $(this).prop("disabled", true);
        $(this).html('<i class="fa fa-spinner fa-spin me-2"></i> Processing...');
        e.preventDefault();

        var form = $(this).closest('form');
        var transactionAmount = parseFloat($('#hidden_transaction_amount').val()) || 0;

        if ($('#editAmountCheckbox').is(':checked')) {
            var enteredRefundAmount = parseFloat($('.final_refund_amount').val()) || 0;
            if (enteredRefundAmount > transactionAmount) {
                alert('Amount cannot be greater than the charged amount');
                $(this).prop("disabled", false);
                $(this).html('Confirm Refund');
                return;
            }
            if (enteredRefundAmount === 0 || isNaN(enteredRefundAmount)) {
                alert('Amount cannot be blank or invalid');
                $(this).prop("disabled", false);
                $(this).html('Confirm Refund');
                return;
            }
        }

        form.submit();
    });
});
</script>
{% endblock page_only_scripts %}