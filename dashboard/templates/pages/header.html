<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Responsive Header</title>
    <style>
        :root {
            --background: #ffffff;
            --foreground: #1f2937;
            --secondary: #f3f4f6;
            --border: #e5e7eb;
            --mono: #6b7280;
            --primary: #3b82f6;
            --muted-foreground: #6b7280;
            --secondary-foreground: #4b5563;
        }

        body {
            background: var(--background);
            color: var(--foreground);
            margin: 0;
            font-family: Arial, sans-serif;
        }

        .header-container {
            background: #ffffff;
            transition: background-color 0.3s;
            border-bottom: 1px solid var(--border);
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 20;
        }

        .kt-mobile-menu-toggle {
            display: none;
        }

        .kt-nav-menu {
            display: flex;
            align-items: center;
            gap: 1.75rem;
        }

        .kt-menu-dropdown {
            display: none;
        }

        .kt-menu-item:hover .kt-menu-dropdown,
        .kt-menu-item.active .kt-menu-dropdown {
            display: block !important;
        }

        .kt-menu-item[data-kt-menu-item-toggle="dropdown"] .kt-menu-dropdown {
            position: absolute;
            background: #ffffff;
            border: 1px solid var(--border);
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 50;
            min-width: 200px;
        }

        #search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 0.375rem;
            margin-top: 4px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 105;
            max-height: 240px;
            overflow-y: auto;
        }

        #search-suggestions li {
            padding: 8px 16px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        #search-suggestions li:hover {
            background-color: #f3f4f6;
        }

        .bg-background { background: #ffffff; }
        .text-foreground { color: var(--foreground); }
        .text-secondary-foreground { color: var(--secondary-foreground); }
        .text-muted-foreground { color: var(--muted-foreground); }
        .border-border { border-color: var(--border); }
        .hover\:text-primary:hover { color: var(--primary); }
        .text-mono { color: var(--mono); }
        .hover\:bg-secondary:hover { background: var(--secondary); }
        .bg-muted\/70 { background: var(--secondary); opacity: 0.7; }
        .kt-btn-secondary { background: var(--secondary); }
        .kt-btn-ghost:hover { background: var(--secondary); }
        .kt-btn-ghost:hover i { color: var(--primary); }
        .kt-dropdown-menu { background: #ffffff; border: 1px solid var(--border); }
        .kt-card { background: var(--secondary); }
        .kt-switch:checked { background: var(--primary); }
        .kt-wishlist-icon { cursor: pointer; transition: color 0.3s; }
        .kt-wishlist-icon.active { color: #ff0000; }
        .kt-wishlist-icon:hover { color: #cc0000; }
        .wishlist-item-img { object-fit: cover; border-radius: 4px; }
        .remove-cart-item {
            background-color: #ef4444;
            color: white;
            border-radius: 0.375rem;
            padding: 0.25rem 0.5rem;
            transition: background-color 0.3s;
        }
        .remove-cart-item:hover { background-color: #dc2626; }
        .remove-cart-item i { font-size: 1rem; }
        .cart-total {
            background-color: var(--secondary);
            padding: 1rem;
            border-top: 1px solid var(--border);
            border-radius: 0 0 0.375rem 0.375rem;
            font-weight: 600;
        }
        #clear-search { cursor: pointer; border: none; outline: none; }
        #clear-search:hover i { color: #374151; }
        #search-input:hover {
            box-shadow: 0 0 0 2px #3b82f6;
            border-color: #3b82f6;
        }

        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .gap-1 { gap: 0.25rem; }
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 0.75rem; }
        .gap-4 { gap: 1rem; }
        .gap-5 { gap: 1.25rem; }
        .px-2 { padding-left: 0.5rem; padding-right: 0.5rem; }
        .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .px-5 { padding-left: 1.25rem; padding-right: 1.25rem; }
        .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .flex-1 { flex: 1 1 0%; }
        .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
        .text-xs { font-size: 0.75rem; line-height: 1rem; }
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .rounded { border-radius: 0.25rem; }
        .rounded-md { border-radius: 0.375rem; }
        .rounded-lg { border-radius: 0.5rem; }
        .rounded-xl { border-radius: 0.75rem; }
        .rounded-full { border-radius: 9999px; }
        .border { border-width: 1px; }
        .border-t { border-top-width: 1px; }
        .border-b { border-bottom-width: 1px; }
        .hidden { display: none; }
        .block { display: block; }
        .relative { position: relative; }
        .absolute { position: absolute; }
        .fixed { position: fixed; }
        .top-0 { top: 0; }
        .left-0 { left: 0; }
        .right-0 { right: 0; }
        .z-10 { z-index: 10; }
        .z-20 { z-index: 20; }
        .z-50 { z-index: 50; }
        .z-100 { z-index: 100; }

        .container {
            width: 100%;
            margin-left: auto;
            margin-right: auto;
            padding-left: 1rem;
            padding-right: 1rem;
        }

        @media (min-width: 640px) {
            .container { max-width: 640px; }
            .sm\:px-6 { padding-left: 1.5rem; padding-right: 1.5rem; }
            .sm\:gap-5 { gap: 1.25rem; }
            .sm\:text-base { font-size: 1rem; line-height: 1.5rem; }
            .sm\:w-\[450px\] { width: 450px; }
            .sm\:hidden { display: none; }
        }

        @media (min-width: 768px) {
            .container { max-width: 768px; }
            .md\:block { display: block; }
        }

        @media (min-width: 1024px) {
            .container { max-width: 1024px; }
        }

        @media (min-width: 1280px) {
            .container { max-width: 1280px; }
        }

        @media (min-width: 1536px) {
            .container { max-width: 1536px; }
        }

        @media (max-width: 1200px) {
            .container {
                padding-left: 1rem;
                padding-right: 1rem;
            }
        }

        @media (max-width: 992px) {
            .kt-nav-menu {
                gap: 1rem;
            }

            .kt-nav-menu .kt-menu-link span {
                font-size: 0.8rem;
            }
        }

        @media (max-width: 768px) {
            .header-container {
                position: relative;
            }

            .kt-mobile-menu-toggle {
                display: flex !important;
            }

            .kt-nav-menu {
                display: none;
                flex-direction: column;
                width: 100%;
                position: absolute;
                top: 100%;
                left: 0;
                background: #ffffff;
                border-top: 1px solid #e5e7eb;
                z-index: 100;
                padding: 1rem;
                gap: 0.5rem;
                transition: all 0.3s ease;
            }

            .kt-nav-menu.active {
                display: flex !important;
            }

            .kt-nav-menu .kt-menu-link {
                justify-content: flex-start;
                padding: 0.75rem 1rem;
            }

            .kt-nav-menu .border-e {
                display: none;
            }

            .header-left .font-semibold {
                display: none;
            }

            .kt-menu-item[data-kt-menu-item-toggle="dropdown"] .kt-menu-dropdown {
                position: static;
                width: 100%;
                box-shadow: none;
                margin-top: 0.5rem;
                border-radius: 0.375rem;
                display: none;
            }

            .kt-menu-item[data-kt-menu-item-toggle="dropdown"].active .kt-menu-dropdown {
                display: block !important;
            }

            .search-container {
                flex: 1;
                max-width: none;
                margin: 0 0.5rem;
            }

            #search-input {
                font-size: 16px;
                height: 2.5rem;
            }

            .header-actions {
                gap: 0.25rem;
            }

            .header-actions .kt-btn {
                width: 2rem;
                height: 2rem;
                padding: 0;
            }

            .header-actions .kt-btn i {
                font-size: 1rem;
            }

            .kt-dropdown-menu {
                right: 0;
                left: auto;
                min-width: 280px;
                max-width: 90vw;
            }
        }

        @media (max-width: 640px) {
            .header-container header {
                height: auto;
                min-height: 3.5rem;
                padding: 0.75rem 1rem;
            }

            .header-left {
                padding: 0;
                margin: 0;
                gap: 0.5rem;
            }

            .header-left img {
                width: 2rem;
                height: 2rem;
            }

            .search-container {
                margin: 0 0.25rem;
            }

            .header-actions {
                padding: 0;
                margin: 0;
                gap: 0.25rem;
            }

            .bottom-header {
                padding: 0.5rem 1rem;
                height: auto;
                min-height: 3rem;
            }

            .kt-drawer {
                max-width: 95% !important;
                width: 100% !important;
                top: 1rem !important;
                bottom: 1rem !important;
                left: 2.5% !important;
                right: 2.5% !important;
            }

            #drawers_shop_cart,
            #drawers_shop_wishlist {
                max-width: 95% !important;
                width: 100% !important;
            }

            .kt-card-content img {
                max-height: 120px;
            }

            .kt-card-content h3 {
                font-size: 1.2rem;
            }

            .wishlist-drawer-toggle {
                font-size: 1rem;
            }
        }

        @media (max-width: 480px) {
            .header-container header {
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            .header-top {
                width: 100%;
                order: 1;
            }

            .search-container {
                width: 100%;
                order: 2;
                margin: 0;
                margin-top: 0.5rem;
            }

            .bottom-header .container {
                padding: 0 0.5rem;
            }

            .kt-nav-menu {
                padding: 0.5rem;
            }

            .kt-dropdown-menu {
                min-width: 260px;
            }

            .header-actions .kt-btn {
                width: 1.75rem;
                height: 1.75rem;
            }

            .header-actions .kt-btn i {
                font-size: 0.875rem;
            }
        }

        @media (max-width: 768px) and (orientation: landscape) {
            .header-container header {
                min-height: 3rem;
                padding: 0.5rem 1rem;
            }

            .bottom-header {
                min-height: 2.5rem;
                padding: 0.25rem 1rem;
            }

            .kt-nav-menu .kt-menu-link {
                padding: 0.5rem 1rem;
            }
        }

        @media (hover: none) and (pointer: coarse) {
            .kt-btn,
            .kt-menu-link,
            .kt-dropdown-menu-link {
                min-height: 44px;
                min-width: 44px;
            }

            .kt-menu-item[data-kt-menu-item-toggle="dropdown"] {
                position: relative;
            }

            .kt-menu-item[data-kt-menu-item-toggle="dropdown"].active .kt-menu-dropdown {
                display: block !important;
            }
        }

        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .header-left img {
                image-rendering: -webkit-optimize-contrast;
                image-rendering: crisp-edges;
            }
        }

        .touch-device .kt-btn,
        .touch-device .kt-menu-link {
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
        }

        @media screen and (-webkit-min-device-pixel-ratio: 1.5) {
            .kt-drawer {
                transform: translateZ(0);
            }
        }

        @media (prefers-contrast: high) {
            .border-border {
                border-color: ButtonText;
            }
            .text-muted-foreground {
                color: ButtonText;
            }
        }

        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        @media print {
            .header-container {
                position: static !important;
                background: white !important;
            }
            .kt-drawer,
            .kt-btn-ghost,
            .kt-mobile-menu-toggle {
                display: none !important;
            }
        }
    </style>
</head>
<body>
<div class="w-full header-container">
    <header class="flex items-center justify-between h-[50px] px-4 sm:px-6 transition-[height] shrink-0">
        <div class="header-left flex items-center gap-2 sm:gap-4 px-2 sm:px-5">
            <a href="#" class="flex items-center gap-2">
                <img class="size-8 sm:size-10"
                     src="{% static 'metronic/tailwind/dist/assets/media/brand-logos/health_logo_bg.png' %}"
                     alt="Logo"/>
                <span class="hidden sm:block text-sm sm:text-base font-semibold">Health Equipment</span>
            </a>
            <button class="kt-mobile-menu-toggle kt-btn kt-btn-icon kt-btn-secondary rounded-full size-8 flex items-center justify-center md:hidden">
                <i class="ki-filled ki-menu"></i>
            </button>
        </div>

        <div class="search-container flex-1 max-w-2xl mx-2 sm:mx-4">
            <form class="relative" id="search-form" action="{% url 'dashboard:search_results_grid' %}">
                <div class="relative">
                    <input type="text" name="q" id="search-input"
                           class="w-full h-10 px-4 pr-16 text-sm rounded-full border
                          border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500
                          hover:ring-2 hover:ring-blue-500 bg-gray-100
                          text-gray-900 placeholder-gray-500 transition-colors"
                           placeholder="Search products..." value="{{ search_query|default:'' }}" autocomplete="off"/>
                    <div id="search-suggestions"
                         class="hidden">
                        <ul id="suggestions-list" class="list-none p-0"></ul>
                    </div>
                    <div class="absolute right-2 top-1/2 -translate-y-1/2 flex items-center space-x-2">
                        <button type="submit" aria-label="Search" class="p-2 rounded-full transition-colors
                                               bg-blue-600 hover:bg-blue-500 text-white">
                            <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                 stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M21 21l-4.35-4.35M17 11a6 6 0 11-12 0 6 6 0 0112 0z"></path>
                            </svg>
                        </button>
                        <button type="button" id="clear-search"
                                class="w-6 h-6 flex items-center justify-center rounded-full bg-gray-200 hover:bg-gray-300 transition-colors"
                                style="display: none;">
                            <i class="ki-filled ki-cross text-gray-600 text-lg"></i>
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <div class="header-actions flex items-center gap-1 sm:gap-3 px-2 sm:px-5">
            <a href="{% url 'dashboard:wish_list' %}"
               class="kt-btn kt-btn-ghost kt-btn-icon size-8 hover:bg-background hover:[&_i]:text-primary">
                <i class="ki-filled ki-heart text-base sm:text-xl"></i>
            </a>

            <a href="{% url 'dashboard:shopping_cart' %}"
               class="kt-btn kt-btn-ghost kt-btn-icon size-8 hover:bg-background hover:[&_i]:text-primary">
                <i class="ki-filled ki-handcart text-base"></i>
            </a>

            <button class="kt-btn kt-btn-ghost kt-btn-icon size-8 hover:bg-background hover:[&_i]:text-primary"
                    data-kt-drawer-toggle="#notifications_drawer">
                <i class="ki-filled ki-notification-status text-base sm:text-lg"></i>
            </button>

            <div class="border-e border-border h-6 hidden sm:block"></div>

            <div class="relative group" data-kt-dropdown="true" data-kt-dropdown-offset="10px, 10px"
                 data-kt-dropdown-offset-rtl="-20px, 10px" data-kt-dropdown-placement="bottom-end"
                 data-kt-dropdown-trigger="click">
                <div class="cursor-pointer" data-kt-dropdown-toggle="true">
                    <img alt="User Avatar" class="size-8 sm:size-9 rounded-full border-2 border-mono/25"
                         src="{% if header_avatar_url %}{{ header_avatar_url }}{% else %}{% static 'metronic/tailwind/dist/assets/media/avatars/default-avatar.png' %}{% endif %}"/>
                </div>
                <div class="kt-dropdown-menu w-[250px] sm:w-[280px] bg-background border border-border rounded-lg shadow-lg py-2 z-10 hidden group-[data-kt-dropdown-toggle='true']:block"
                     data-kt-dropdown-menu="true">
                    <div class="flex items-center justify-between px-2.5 py-1.5 gap-1.5">
                        <div class="flex items-center gap-2">
                            <img alt="User Avatar" class="size-9 rounded-full border-2 border-green-500"
                                 src="{% if header_avatar_url %}{{ header_avatar_url }}{% else %}{% static 'metronic/tailwind/dist/assets/media/avatars/default-avatar.png' %}{% endif %}"/>
                            <div class="flex flex-col gap-1.5">
                                <span class="text-sm text-foreground font-semibold">{{request.user.first_name}} {{request.user.last_name}}</span>
                                <a class="text-xs text-secondary-foreground hover:text-primary font-medium"
                                   href="https://keenthemes.com/metronic/tailwind/demo10/account/home/get-started">
                                    {{request.user.email}}
                                </a>
                            </div>
                        </div>
                    </div>
                    <ul class="kt-dropdown-menu-sub">
                        <li>
                            <div class="kt-dropdown-menu-separator border-t border-border my-1"></div>
                        </li>
                        <li>
                            <a class="kt-dropdown-menu-link flex items-center gap-2 px-4 py-2 hover:bg-secondary"
                               href="{% url 'dashboard:user_profile' %}">
                                <i class="ki-filled ki-profile-circle text-base"></i> My Profile
                            </a>
                        </li>
                        <li class="relative group" data-kt-dropdown="true" data-kt-dropdown-placement="right-start"
                            data-kt-dropdown-trigger="hover">
                            <button class="kt-dropdown-menu-toggle flex items-center gap-2 px-4 py-2 w-full text-left hover:bg-secondary"
                                    data-kt-dropdown-toggle="true">
                                <i class="ki-filled ki-setting-2 text-base"></i> My Account
                                <span class="kt-dropdown-menu-indicator ml-auto">
                                    <i class="ki-filled ki-right text-base text-xs"></i>
                                </span>
                            </button>
                            <div class="kt-dropdown-menu w-[220px] bg-background border border-border rounded-lg shadow-lg py-2 hidden absolute left-full top-0 ml-1 group-hover:block"
                                 data-kt-dropdown-menu="true">
                                <ul class="kt-dropdown-menu-sub">
                                    <li>
                                        <a class="kt-dropdown-menu-link flex items-center gap-2 px-4 py-2 hover:bg-secondary"
                                           href="{% url 'dashboard:view_user_quotations' %}">
                                            <i class="bi bi-envelope-paper text-base"></i>
                                            View Quotations
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </li>
                        <li>
                            <a class="kt-dropdown-menu-link flex items-center gap-2 px-4 py-2 hover:bg-secondary"
                               href="{% url 'dashboard:request_role' %}">
                                <i class="ki-filled ki-profile-circle text-base"></i> Become a Supplier
                            </a>
                        </li>
                        <li>
                            <div class="kt-dropdown-menu-separator border-t border-border my-1"></div>
                        </li>
                    </ul>
                    <div class="px-2.5 pt-1.5 mb-2.5 flex flex-col gap-3.5">
                        {% if user.is_authenticated %}
                        <a class="kt-btn kt-btn-outline justify-center w-full"
                           href="{% url 'dashboard:user_logout' %}">Log out
                        </a>
                        {% else %}
                        <a class="kt-btn kt-btn-sm bg-blue-600 text-white hover:bg-blue-700"
                           href="{% url 'dashboard:login' %}">Sign In
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% if user.is_authenticated %}
            <a class="hidden sm:flex kt-btn kt-btn-ghost kt-btn-icon size-8 hover:bg-background hover:[&_i]:text-primary"
               href="{% url 'dashboard:user_logout' %}">
                <i class="ki-filled ki-exit-right text-base"></i>
            </a>
            {% else %}
            <a class="hidden sm:flex kt-btn kt-btn-sm bg-blue-600 text-white hover:bg-blue-700"
               href="{% url 'dashboard:login' %}">Sign In
            </a>
            {% endif %}
        </div>
    </header>

    <header class="bottom-header flex items-center h-[50px] px-4 sm:px-6 transition-[height] shrink-0 mt-1 mb-1">
        <div class="container flex justify-center items-center gap-3.5">
            <div class="kt-nav-menu flex items-center gap-4 sm:gap-7 flex-wrap">
                <a class="kt-menu-link flex items-center gap-2 px-3 py-2 text-2sm leading-none relative h-8.5 rounded-full border
                        {% if request.resolver_match.url_name == 'home' %}
                            bg-secondary text-primary border-primary/10 bg-primary/10 [&_.kt-step-icon]:text-primary
                        {% else %}
                            border-border text-foreground hover:bg-secondary [&_.kt-step-icon]:text-muted-foreground
                        {% endif %}"
                   href="{% url 'dashboard:home' %}">
                    <i class="ki-filled ki-home text-base"></i>
                    <span class="text-sm">Home</span>
                </a>
                <div class="border-e border-border h-6 hidden md:block"></div>

                <div class="kt-menu-item relative group" data-kt-menu-item-toggle="dropdown"
                     data-kt-menu-item-trigger="hover">
                    <a class="kt-menu-link flex items-center gap-2 px-3 py-2 text-2sm leading-none relative h-8.5 rounded-full border
                            border-border text-foreground hover:bg-secondary [&_.kt-step-icon]:text-muted-foreground"
                       href="#">
                        <i class="ki-filled ki-handcart text-base"></i>
                        <span class="text-sm">Cart & More</span>
                    </a>
                    <div class="kt-menu-dropdown absolute w-48 bg-background border border-border rounded-lg shadow-lg z-10 hidden mt-7 py-5 px-3">
                        <div class="kt-menu-item">
                            <a class="kt-menu-link flex items-center gap-2 px-4 py-2 text-2sm leading-none relative h-8.5 rounded-full border
                                    {% if request.resolver_match.url_name == 'shopping_cart' %}
                                        bg-secondary text-primary border-primary/10 bg-primary/10 [&_.kt-step-icon]:text-primary
                                    {% else %}
                                        border-border text-foreground hover:bg-secondary [&_.kt-step-icon]:text-muted-foreground
                                    {% endif %}"
                               href="{% url 'dashboard:shopping_cart' %}">
                                <i class="ki-filled ki-handcart text-base"></i>
                                <span class="text-sm">Shopping Cart</span>
                            </a>
                        </div>
                        <div class="kt-menu-item mt-3">
                            <a class="kt-menu-link flex items-center gap-2 px-4 py-2 text-2sm leading-none relative h-8.5 rounded-full border
                                    {% if request.resolver_match.url_name == 'wish_list' %}
                                        bg-secondary text-primary border-primary/10 bg-primary/10 [&_.kt-step-icon]:text-primary
                                    {% else %}
                                        border-border text-foreground hover:bg-secondary [&_.kt-step-icon]:text-muted-foreground
                                    {% endif %}"
                               href="{% url 'dashboard:wish_list' %}">
                                <i class="ki-filled ki-heart text-base"></i>
                                <span class="text-sm">Wishlist</span>
                            </a>
                        </div>
                        <div class="kt-menu-item mt-3">
                            <a class="kt-menu-link flex items-center gap-2 px-4 py-2 text-2sm leading-none relative h-8.5 rounded-full border
                                    {% if request.resolver_match.url_name == 'subscription_plans' %}
                                        bg-secondary text-primary border-primary/10 bg-primary/10 [&_.kt-step-icon]:text-primary
                                    {% else %}
                                        border-border text-foreground hover:bg-secondary [&_.kt-step-icon]:text-muted-foreground
                                    {% endif %}"
                               href="{% url 'dashboard:subscription_plans' %}">
                                <i class="ki-filled ki-scroll text-base"></i>
                                <span class="text-sm">Subscription Plan</span>
                            </a>
                        </div>
                    </div>
                </div>

                <div class="border-e border-border h-6 hidden md:block"></div>
                <div class="kt-menu-item relative group" data-kt-menu-item-toggle="dropdown"
                     data-kt-menu-item-trigger="hover">
                    <a class="kt-menu-link flex items-center gap-2 px-3 py-2 text-2sm leading-none relative h-8.5 rounded-full border
                            border-border text-foreground hover:bg-secondary [&_.kt-step-icon]:text-muted-foreground"
                       href="#">
                        <i class="ki-filled ki-wallet text-base"></i>
                        <span class="text-sm">Checkout</span>
                    </a>
                    <div class="kt-menu-dropdown absolute w-40 bg-background border border-border rounded-lg shadow-lg z-10 hidden mt-7 py-5 px-3">
                        <div class="kt-menu-item">
                            <a class="kt-menu-link flex items-center gap-2 px-4 py-2 text-2sm leading-none relative h-8.5 rounded-full border
                                    {% if request.resolver_match.url_name == 'shipping_info' %}
                                        bg-secondary text-primary border-primary/10 bg-primary/10 [&_.kt-step-icon]:text-primary
                                    {% else %}
                                        border-border text-foreground hover:bg-secondary [&_.kt-step-icon]:text-muted-foreground
                                    {% endif %}"
                               href="{% url 'dashboard:shipping_info' %}">
                                <i class="ki-filled ki-delivery text-base"></i>
                                <span class="text-sm">Shipping Info</span>
                            </a>
                        </div>
                        <div class="kt-menu-item mt-3">
                            <a class="kt-menu-link flex items-center gap-2 px-4 py-2 text-2sm leading-none relative h-8.5 rounded-full border
                                    {% if request.resolver_match.url_name == 'payment_method' %}
                                        bg-secondary text-primary border-primary/10 bg-primary/10 [&_.kt-step-icon]:text-primary
                                    {% else %}
                                        border-border text-foreground hover:bg-secondary [&_.kt-step-icon]:text-muted-foreground
                                    {% endif %}"
                               href="{% url 'dashboard:payment_method' %}">
                                <i class="ki-filled ki-two-credit-cart text-base"></i>
                                <span class="text-sm">Payment Method</span>
                            </a>
                        </div>
                        <div class="kt-menu-item mt-3">
                            <a class="kt-menu-link flex items-center gap-2 px-4 py-2 text-2sm leading-none relative h-8.5 rounded-full border
                                    {% if request.resolver_match.url_name == 'order_placed' %}
                                        bg-secondary text-primary border-primary/10 bg-primary/10 [&_.kt-step-icon]:text-primary
                                    {% else %}
                                        border-border text-foreground hover:bg-secondary [&_.kt-step-icon]:text-muted-foreground
                                    {% endif %}"
                               href="{% url 'dashboard:order_placed' %}">
                                <i class="ki-filled ki-cheque text-base"></i>
                                <span class="text-sm">Order Placed</span>
                            </a>
                        </div>
                    </div>
                </div>

                <div class="border-e border-border h-6 hidden md:block"></div>
                <div class="kt-menu-item relative">
                    <a class="kt-menu-link flex items-center gap-2 px-3 py-2 text-2sm leading-none relative h-8.5 rounded-full border
                            {% if request.resolver_match.url_name == 'my_orders' %}
                                bg-secondary text-primary border-primary/10 bg-primary/10 [&_.kt-step-icon]:text-primary
                            {% else %}
                                border-border text-foreground hover:bg-secondary [&_.kt-step-icon]:text-muted-foreground
                            {% endif %}"
                       href="{% url 'dashboard:my_orders' %}">
                        <i class="ki-filled ki-package text-base"></i>
                        <span class="text-sm">My Orders</span>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <div class="hidden kt-drawer kt-drawer-end card flex-col max-w-[90%] w-[400px] sm:w-[450px] top-5 bottom-5 end-5 rounded-xl border border-border"
         data-kt-drawer="true" data-kt-drawer-container="body" id="notifications_drawer">
        <div class="flex items-center justify-between gap-2.5 text-sm text-mono font-semibold px-5 py-2.5 border-b border-b-border"
             id="notifications_header">
            Notifications
            <button class="kt-btn kt-btn-sm kt-btn-icon kt-btn-dim shrink-0" data-kt-drawer-dismiss="true">
                <i class="ki-filled ki-cross"></i>
            </button>
        </div>
        <div class="kt-tabs kt-tabs-line justify-between px-5 mb-2" data-kt-tabs="true" id="notifications_tabs">
            <div class="flex items-center gap-2 sm:gap-5">
                <button class="kt-tab-toggle py-3 active" data-kt-tab-toggle="#notifications_tab_all">All</button>
                <button class="kt-tab-toggle py-3 relative" data-kt-tab-toggle="#notifications_tab_inbox">
                    Inbox
                    <span class="rounded-full bg-green-500 size-[5px] absolute top-2 end-0 transform translate-y-1/2 translate-x-full"></span>
                </button>
                <button class="kt-tab-toggle py-3" data-kt-tab-toggle="#notifications_tab_team">Team</button>
                <button class="kt-tab-toggle py-3 hidden sm:block" data-kt-tab-toggle="#notifications_tab_following">Following</button>
            </div>
            <div class="kt-menu" data-kt-menu="true">
                <button class="kt-menu-toggle kt-btn kt-btn-icon kt-btn-ghost">
                    <i class="ki-filled ki-setting-2"></i>
                </button>
                <div class="kt-menu-dropdown kt-menu-default w-full max-w-[175px]" data-kt-menu-dismiss="true">
                    <div class="kt-menu-item">
                        <a class="kt-menu-link flex items-center gap-2 px-4 py-2 hover:bg-secondary" href="#">
                            <i class="ki-filled ki-document"></i>
                            <span class="kt-menu-title">View</span>
                        </a>
                    </div>
                    <div class="kt-menu-item" data-kt-menu-item-offset="-15px, 0"
                         data-kt-menu-item-placement="right-start" data-kt-menu-item-toggle="dropdown"
                         data-kt-menu-item-trigger="click|lg:hover">
                        <div class="kt-menu-link flex items-center gap-2 px-4 py-2 hover:bg-secondary">
                            <i class="ki-filled ki-notification-status"></i>
                            <span class="kt-menu-title">Export</span>
                            <span class="kt-menu-arrow"><i
                                    class="ki-filled ki-right text-xs rtl:transform rtl:rotate-180"></i></span>
                        </div>
                        <div class="kt-menu-dropdown kt-menu-default w-full max-w-[175px]">
                            <div class="kt-menu-item">
                                <a class="kt-menu-link flex items-center gap-2 px-4 py-2 hover:bg-secondary"
                                   href="https://keenthemes.com/metronic/tailwind/demo10/account/home/settings-sidebar">
                                    <i class="ki-filled ki-sms"></i>
                                    <span class="kt-menu-title">Email</span>
                                </a>
                            </div>
                            <div class="kt-menu-item">
                                <a class="kt-menu-link flex items-center gap-2 px-4 py-2 hover:bg-secondary"
                                   href="https://keenthemes.com/metronic/tailwind/demo10/account/home/settings-sidebar">
                                    <i class="ki-filled ki-message-notify"></i>
                                    <span class="kt-menu-title">SMS</span>
                                </a>
                            </div>
                            <div class="kt-menu-item">
                                <a class="kt-menu-link flex items-center gap-2 px-4 py-2 hover:bg-secondary"
                                   href="https://keenthemes.com/metronic/tailwind/demo10/account/home/settings-sidebar">
                                    <i class="ki-filled ki-notification-status"></i>
                                    <span class="kt-menu-title">Push</span>
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="kt-menu-item">
                        <a class="kt-menu-link flex items-center gap-2 px-4 py-2 hover:bg-secondary" href="#">
                            <i class="ki-filled ki-pencil"></i>
                            <span class="kt-menu-title">Edit</span>
                        </a>
                    </div>
                    <div class="kt-menu-item">
                        <a class="kt-menu-link flex items-center gap-2 px-4 py-2 hover:bg-secondary" href="#">
                            <i class="ki-filled ki-trash"></i>
                            <span class="kt-menu-title">Delete</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
        <div class="grow flex flex-col" id="notifications_tab_all">
            <div class="grow kt-scrollable-y-auto" data-kt-scrollable="true" data-kt-scrollable-dependencies="#header"
                 data-kt-scrollable-max-height="auto" data-kt-scrollable-offset="150px">
                <div class="grow flex flex-col gap-5 pt-3 pb-4 divider-y divider-border">
                    <div class="flex grow gap-2.5 px-5">
                        <div class="kt-avatar size-8">
                            <div class="kt-avatar-image">
                                <img alt="avatar"
                                     src="{% static 'metronic/tailwind/dist/assets/media/avatars/300-4.png' %}"/>
                            </div>
                            <div class="kt-avatar-indicator -end-2 -bottom-2">
                                <div class="kt-avatar-status kt-avatar-status-online size-2.5"></div>
                            </div>
                        </div>
                        <div class="flex flex-col gap-3.5">
                            <div class="flex flex-col gap-1">
                                <div class="text-sm font-medium">
                                    <a class="hover:text-primary text-mono font-semibold" href="#">Joe Lincoln</a>
                                    <span class="text-secondary-foreground"> mentioned you in </span>
                                    <a class="hover:text-primary text-primary" href="#">Latest Trends</a>
                                    <span class="text-secondary-foreground"> topic</span>
                                </div>
                                <span class="flex items-center text-xs font-medium text-muted-foreground">
                                    18 mins ago
                                    <span class="rounded-full size-1 bg-mono/30 mx-1.5"></span>
                                    Web Design 2024
                                </span>
                            </div>
                            <div class="kt-card shadow-none flex flex-col gap-2.5 p-3.5 rounded-lg bg-muted/70">
                                <div class="text-sm font-semibold text-secondary-foreground mb-px">
                                    <a class="hover:text-primary text-mono font-semibold" href="#">@Cody</a>
                                    <span class="text-secondary-foreground font-medium">For an expert opinion, check out what Mike has to say on this topic!</span>
                                </div>
                                <div class="kt-input">
                                    <input placeholder="Reply" type="text" value=""/>
                                    <button class="kt-btn kt-btn-ghost kt-btn-icon size-6 -me-1.5">
                                        <i class="ki-filled ki-picture"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="border-b border-b-border"></div>
            <div class="grid grid-cols-2 p-5 gap-2.5" id="notifications_all_footer">
                <button class="kt-btn kt-btn-outline justify-center">Archive all</button>
                <button class="kt-btn kt-btn-outline justify-center">Mark all as read</button>
            </div>
        </div>
    </div>

    <div class="hidden kt-drawer kt-drawer-end card flex-col max-w-[95%] w-[600px] top-5 bottom-5 end-5 rounded-xl border border-border"
         data-kt-drawer="true" data-kt-drawer-container="body" id="drawers_shop_wishlist">
        <div class="kt-card-header px-5">
            <h3 class="kt-card-title">Wishlist</h3>
            <button class="kt-btn kt-btn-sm kt-btn-icon kt-btn-ghost shrink-0" data-kt-drawer-dismiss="true">
                <i class="ki-filled ki-cross text-base"></i>
            </button>
        </div>
        <div class="kt-card-content flex flex-col p-5 kt-scrollable-y-auto">
            <div id="wishlist-items" class="flex flex-col gap-4"></div>
        </div>
    </div>

    <div class="hidden kt-drawer kt-drawer-end card flex-col max-w-[95%] w-[600px] top-5 bottom-5 end-5 rounded-xl border border-border"
         data-kt-drawer="true" data-kt-drawer-container="body" id="drawers_shop_cart">
        <div class="kt-card-header px-5">
            <h3 class="kt-card-title">Cart</h3>
            <button id="cart-close-btn" class="kt-btn kt-btn-sm kt-btn-icon kt-btn-ghost shrink-0"
                    data-kt-drawer-dismiss="true">
                <i class="ki-filled ki-cross text-base"></i>
            </button>
        </div>
        <div class="kt-card-content flex flex-col p-5 kt-scrollable-y-auto" id="cart-items"></div>
        <div class="kt-card-footer px-5 py-3 flex flex-col sm:flex-row justify-between gap-3">
            <button class="kt-btn kt-btn-outline w-full sm:w-1/2" id="cart-clear">Clear Cart</button>
            <button class="kt-btn kt-btn-primary w-full sm:w-1/2" id="buy-now">Buy Now</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Mobile Menu Toggle
    const mobileMenuToggle = document.querySelector('.kt-mobile-menu-toggle');
    const navMenu = document.querySelector('.kt-nav-menu');

    if (mobileMenuToggle && navMenu) {
        mobileMenuToggle.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            navMenu.classList.toggle('active');
            const icon = mobileMenuToggle.querySelector('i');
            if (icon) {
                icon.classList.toggle('ki-menu');
                icon.classList.toggle('ki-cross');
            }
        });

        document.addEventListener('click', (e) => {
            if (!navMenu.contains(e.target) && !mobileMenuToggle.contains(e.target) && navMenu.classList.contains('active')) {
                navMenu.classList.remove('active');
                const icon = mobileMenuToggle.querySelector('i');
                if (icon) {
                    icon.classList.add('ki-menu');
                    icon.classList.remove('ki-cross');
                }
            }
        });

        const mobileDropdownToggles = navMenu.querySelectorAll('[data-kt-menu-item-toggle="dropdown"]');
        mobileDropdownToggles.forEach(toggle => {
            toggle.addEventListener('click', function(e) {
                if (window.innerWidth <= 768) {
                    e.preventDefault();
                    this.classList.toggle('active');
                    const dropdown = this.querySelector('.kt-menu-dropdown');
                    if (dropdown) {
                        dropdown.classList.toggle('block');
                    }
                }
            });
        });
    }

    // Reset menu on resize
    window.addEventListener('resize', () => {
        if (window.innerWidth > 768 && navMenu && navMenu.classList.contains('active')) {
            navMenu.classList.remove('active');
            const icon = mobileMenuToggle?.querySelector('i');
            if (icon) {
                icon.classList.add('ki-menu');
                icon.classList.remove('ki-cross');
            }
        }
    });

    // Utility Functions
    function safeParseJSON(data) {
        try {
            return typeof data === 'string' ? JSON.parse(data) : data;
        } catch (e) {
            console.error('Error parsing JSON:', e);
            return null;
        }
    }

    function getCSRFToken() {
        return document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
    }

    function adjustDrawerPosition() {
        const drawers = document.querySelectorAll('.kt-drawer');
        drawers.forEach(drawer => {
            if (window.innerWidth <= 640) {
                drawer.style.width = '95%';
                drawer.style.maxWidth = '95%';
                drawer.style.left = '2.5%';
                drawer.style.right = '2.5%';
            } else if (window.innerWidth <= 768) {
                drawer.style.width = '90%';
                drawer.style.maxWidth = '90%';
                drawer.style.left = '5%';
                drawer.style.right = '5%';
            }
        });
    }

    adjustDrawerPosition();
    window.addEventListener('resize', adjustDrawerPosition);

    // Cart and Wishlist
    let cart = [];
    try {
        cart = JSON.parse(localStorage.getItem('cart')) || [];
    } catch (e) {
        localStorage.setItem('cart', JSON.stringify([]));
    }

    let wishlist = [];

    function fetchWishlistFromServer() {
        fetch('/wishlist/products/')
            .then(response => response.json())
            .then(data => {
                wishlist = data;
                localStorage.setItem('wishlist', JSON.stringify(wishlist));
                updateWishlistUI();
                updateWishlistIcons();
            })
            .catch(error => console.error('Error fetching wishlist:', error));
    }

    function fetchCartFromServer() {
        fetch('/add-to-cart/')
            .then(response => response.json())
            .then(data => {
                const serverCart = data.cart || [];
                cart = serverCart.map(item => JSON.stringify({
                    id: item.id,
                    name: item.name,
                    price: item.price,
                    quantity: item.quantity,
                    image: item.image,
                    sku: item.id
                }));
                localStorage.setItem('cart', JSON.stringify(cart));
                updateCartUI();
            })
            .catch(error => {
                console.error('Error syncing cart:', error);
            });
    }

    // Search Functionality
    const searchInput = document.getElementById('search-input');
    const suggestionsContainer = document.getElementById('search-suggestions');
    const suggestionsList = document.getElementById('suggestions-list');
    const clearSearch = document.getElementById('clear-search');

    if (searchInput && suggestionsContainer && suggestionsList) {
        searchInput.addEventListener('input', debounce(function () {
            const query = searchInput.value.trim();
            if (query.length < 2) {
                suggestionsContainer.classList.add('hidden');
                suggestionsList.innerHTML = '';
                clearSearch.style.display = 'none';
                return;
            }

            clearSearch.style.display = 'flex';

            fetch(`{% url 'dashboard:search_suggestions' %}?q=${encodeURIComponent(query)}`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(response => response.json())
                .then(data => {
                    suggestionsList.innerHTML = '';
                    if (data.suggestions && data.suggestions.length > 0) {
                        data.suggestions.forEach(item => {
                            const li = document.createElement('li');
                            li.className = 'px-4 py-3 hover:bg-gray-100 cursor-pointer text-sm text-gray-900 border-b border-gray-100 last:border-b-0';
                            li.textContent = item.name;
                            li.addEventListener('click', () => {
                                searchInput.value = item.name;
                                suggestionsContainer.classList.add('hidden');
                                document.getElementById('search-form').submit();
                            });
                            suggestionsList.appendChild(li);
                        });
                        suggestionsContainer.classList.remove('hidden');
                    } else {
                        suggestionsContainer.classList.add('hidden');
                    }
                })
                .catch(error => console.error('Search suggestions error:', error));
        }, 300));

        clearSearch.addEventListener('click', function (e) {
            e.preventDefault();
            searchInput.value = '';
            suggestionsContainer.classList.add('hidden');
            clearSearch.style.display = 'none';
            searchInput.focus();
        });
    }

    document.addEventListener('click', (e) => {
        if (searchInput && suggestionsContainer) {
            if (!searchInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
                suggestionsContainer.classList.add('hidden');
            }
        }
    });

    fetchWishlistFromServer();
    fetchCartFromServer();

    // Touch Device Handling
    if ('ontouchstart' in window) {
        document.body.classList.add('touch-device');
        const dropdownToggles = document.querySelectorAll('[data-kt-dropdown-toggle]');
        dropdownToggles.forEach(toggle => {
            toggle.addEventListener('touchstart', function(e) {
                e.preventDefault();
                this.click();
            });
        });
    }

    function updateWishlistUI() {
        const wishlistContainer = document.querySelector('#drawers_shop_wishlist #wishlist-items');
        if (!wishlistContainer) return;

        wishlistContainer.innerHTML = '';

        if (wishlist.length === 0) {
            wishlistContainer.innerHTML = '<p class="text-sm text-foreground text-center font-monospace mt-5">Your wishlist is empty.</p>';
            return;
        }

        wishlist.forEach(product => {
            const wishlistItem = document.createElement('div');
            wishlistItem.classList.add('flex', 'flex-col', 'sm:flex-row', 'items-start', 'sm:items-center', 'gap-4', 'p-3', 'border', 'border-border', 'rounded-md', 'mb-2');
            wishlistItem.innerHTML = `
                <img src="${product.image}" alt="${product.name}" class="w-16 h-16 wishlist-item-img">
                <div class="flex-1">
                    <h4 class="text-sm font-medium text-mono">${product.name}</h4>
                    <p class="text-xs text-foreground">${product.price}</p>
                </div>
                <div class="flex items-center gap-2 w-full sm:w-auto">
                    <button class="kt-btn kt-btn-sm kt-btn-outline wishlist-add-to-cart flex-1 sm:flex-none" data-id="${product.id}">
                        <i class="ki-filled ki-handcart"></i> <span class="hidden sm:inline">Add to Cart</span>
                    </button>
                    <button class="kt-btn kt-btn-sm kt-btn-icon kt-btn-ghost remove-wishlist-item" data-id="${product.id}">
                        <i class="ki-filled ki-trash text-base"></i>
                    </button>
                </div>
            `;
            wishlistContainer.appendChild(wishlistItem);
        });

        attachWishlistEventListeners();
    }

    function attachWishlistEventListeners() {
        document.querySelectorAll('.remove-wishlist-item').forEach(button => {
            button.addEventListener('click', function () {
                const productId = this.getAttribute('data-id');
                wishlist = wishlist.filter(item => item.id != productId);
                localStorage.setItem('wishlist', JSON.stringify(wishlist));
                updateWishlistUI();
                updateWishlistIcons();

                fetch('/wishlist/toggle/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: `product_id=${productId}`
                });
            });
        });

        document.querySelectorAll('.wishlist-add-to-cart').forEach(button => {
            button.addEventListener('click', function () {
                const productId = this.getAttribute('data-id');

                fetch('/add-to-cart/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: `product_id=${productId}&quantity=1`
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success' || data.status === 'updated') {
                            const cartDrawerToggle = document.querySelector('[data-kt-drawer-toggle="#drawers_shop_cart"]');
                            if (cartDrawerToggle) {
                                cartDrawerToggle.click();
                            }
                            fetchCartFromServer();
                        } else if (data.status === 'removed') {
                            alert('Product removed from cart');
                            fetchCartFromServer();
                        } else {
                            alert('Something went wrong');
                        }
                    })
                    .catch(error => {
                        console.error('Add to cart failed:', error);
                        alert('Error adding product to cart');
                    });
            });
        });
    }

    function updateWishlistIcons() {
        document.querySelectorAll('[data-kt-wishlist-toggle="true"]').forEach(button => {
            const productId = parseInt(button.dataset.productId);
            const icon = button.querySelector('i.heart-icon');
            const isInWishlist = wishlist.some(item => item.id === productId);

            if (isInWishlist) {
                icon?.classList.add('text-red-500');
                button.classList.add('active');
            } else {
                icon?.classList.remove('text-red-500');
                button.classList.remove('active');
            }
        });
    }

    function updateCartIcons(onlyId = null) {
        const selector = onlyId
            ? `.add-to-cart-btn[data-product-id="${onlyId}"]`
            : '.add-to-cart-btn[data-product-id]';

        document.querySelectorAll(selector).forEach(button => {
            const productId = parseInt(button.dataset.productId, 10);
            const inCart = cart.some(item => {
                const parsed = safeParseJSON(item);
                return parsed?.id === productId;
            });

            if (inCart) {
                button.classList.remove('kt-btn-outline');
                button.classList.add('kt-btn-success');
                button.innerHTML = 'In cart <i class="ki-filled ki-handcart"></i>';
            } else {
                button.classList.add('kt-btn-outline');
                button.classList.remove('kt-btn-success');
                button.innerHTML = 'Add <i class="ki-filled ki-handcart"></i>';
            }
        });
    }

    function updateCartUI() {
        const cartContainer = document.querySelector('#cart-items');
        if (cartContainer) {
            cartContainer.innerHTML = '';
            if (cart.length === 0) {
                cartContainer.innerHTML = '<p class="text-sm text-foreground text-center font-monospace mt-5"> Your cart is empty.</p>';
                return;
            }

            let totalPrice = 0;
            cart.forEach(item => {
                const product = safeParseJSON(item);
                if (!product) return;

                let quantity = parseInt(product.quantity) || 1;

                const cartItem = document.createElement('div');
                cartItem.classList.add('flex', 'flex-col', 'sm:flex-row', 'items-start', 'sm:items-center', 'gap-4', 'p-3', 'border', 'border-border', 'rounded-md', 'mb-2');
                cartItem.innerHTML = `
                    <img src="${product.image}" alt="${product.name}" class="w-12 h-12 object-cover rounded">
                    <div class="flex-1">
                        <h4 class="text-sm font-medium text-mono">${product.name}</h4>
                        <p class="text-xs text-foreground">${product.price}</p>
                    </div>
                    <div class="flex items-center gap-2 w-full sm:w-auto justify-between sm:justify-end">
                        <div class="flex items-center gap-2">
                            <button class="kt-btn kt-btn-sm kt-btn-outline qty-decrement" data-sku="${product.sku}">-</button>
                            <span class="qty-display text-sm font-medium min-w-[2rem] text-center">${quantity}</span>
                            <button class="kt-btn kt-btn-sm kt-btn-outline qty-increment" data-sku="${product.sku}">+</button>
                        </div>
                        <button class="remove-cart-item ml-2" data-sku="${product.sku}">
                            <i class="ki-filled ki-trash"></i>
                        </button>
                    </div>
                `;
                cartContainer.appendChild(cartItem);

                const itemPrice = parseFloat(product.price.replace(/[^0-9.]/g, '')) || 0;
                totalPrice += itemPrice * quantity;
            });

            const totalElement = document.createElement('div');
            totalElement.classList.add('cart-total', 'flex', 'items-center', 'justify-between', 'mt-4');
            totalElement.innerHTML = `
                <span class="text-sm font-medium text-mono">Total</span>
                <span class="text-lg font-semibold text-mono">${totalPrice.toFixed(2)}</span>
            `;
            cartContainer.appendChild(totalElement);

            attachCartEventListeners();
        }
    }

    function attachCartEventListeners() {
        document.querySelectorAll('.qty-increment').forEach(button => {
            button.addEventListener('click', function () {
                const sku = this.getAttribute('data-sku');
                const itemIndex = cart.findIndex(item => safeParseJSON(item)?.sku === sku);
                if (itemIndex !== -1) {
                    const product = safeParseJSON(cart[itemIndex]);
                    let quantity = parseInt(product.quantity) || 1;
                    quantity += 1;
                    cart[itemIndex] = JSON.stringify({...product, quantity});
                    localStorage.setItem('cart', JSON.stringify(cart));
                    updateCartUI();
                    updateCartIcons();
                }
            });
        });

        document.querySelectorAll('.qty-decrement').forEach(button => {
            button.addEventListener('click', function () {
                const sku = this.getAttribute('data-sku');
                const itemIndex = cart.findIndex(item => safeParseJSON(item)?.sku === sku);
                if (itemIndex !== -1) {
                    const product = safeParseJSON(cart[itemIndex]);
                    let quantity = parseInt(product.quantity) || 1;
                    if (quantity > 1) {
                        quantity -= 1;
                        cart[itemIndex] = JSON.stringify({...product, quantity});
                        localStorage.setItem('cart', JSON.stringify(cart));
                        updateCartUI();
                        updateCartIcons();
                    }
                }
            });
        });

        document.querySelectorAll('.remove-cart-item').forEach(button => {
            button.addEventListener('click', function () {
                const sku = this.getAttribute('data-sku');
                cart = cart.filter(item => safeParseJSON(item)?.sku !== sku);
                localStorage.setItem('cart', JSON.stringify(cart));
                updateCartUI();
                updateCartIcons();
            });
        });
    }

    document.querySelectorAll('[data-kt-drawer-toggle="#drawers_shop_wishlist"]').forEach(button => {
        button.addEventListener('click', function () {
            fetchWishlistFromServer();
        });
    });

    document.querySelectorAll('[data-kt-drawer-toggle="#drawers_shop_cart"]').forEach(button => {
        button.addEventListener('click', function (e) {
            e.preventDefault();
            const card = this.closest('.kt-card');
            let productData;
            if (card) {
                productData = card.getAttribute('data-product');
            } else {
                productData = this.getAttribute('data-product');
            }
            const product = safeParseJSON(productData);
            if (product) {
                const existingItemIndex = cart.findIndex(item => {
                    const cartProduct = safeParseJSON(item);
                    return cartProduct && cartProduct.sku === product.sku;
                });
                if (existingItemIndex === -1) {
                    cart.push(productData);
                    console.log(`${product.name} added to cart`);
                } else {
                    console.log(`${product.name} is already in cart`);
                }
                localStorage.setItem('cart', JSON.stringify(cart));
                updateCartUI();
                updateCartIcons();
            }
        });
    });

    document.querySelectorAll('[data-kt-wishlist-toggle="true"]').forEach(button => {
        button.addEventListener('click', function (e) {
            e.preventDefault();
            const card = this.closest('.kt-card');
            const product = safeParseJSON(card?.getAttribute('data-product'));
            if (!product) return;

            fetch('/wishlist/toggle/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': getCSRFToken()
                },
                body: `product_id=${product.id}`
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'added') {
                        wishlist.push(product);
                    } else if (data.status === 'removed') {
                        wishlist = wishlist.filter(item => item.id !== product.id);
                    }
                    localStorage.setItem('wishlist', JSON.stringify(wishlist));
                    updateWishlistUI();
                    updateWishlistIcons();
                });
        });
    });

    const clearCartButton = document.querySelector('#cart-clear');
    if (clearCartButton) {
        clearCartButton.addEventListener('click', function () {
            cart = [];
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartUI();
            updateCartIcons();
        });
    }

    const buyNowButton = document.getElementById('buy-now');
    if (buyNowButton) {
        buyNowButton.addEventListener('click', function () {
            if (cart.length > 0) {
                window.location.href = "{% url 'dashboard:shopping_cart' %}";
            } else {
                alert('Your cart is empty. Please add items before proceeding.');
            }
        });
    }
});

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function handleOrientationChange() {
    const navMenu = document.querySelector('.kt-nav-menu');
    const mobileMenuToggle = document.querySelector('.kt-mobile-menu-toggle');
    if (navMenu && navMenu.classList.contains('active')) {
        navMenu.classList.remove('active');
        const icon = mobileMenuToggle?.querySelector('i');
        if (icon) {
            icon.classList.add('ki-menu');
            icon.classList.remove('ki-cross');
        }
    }
    const vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
}

window.addEventListener('orientationchange', handleOrientationChange);
window.addEventListener('resize', handleOrientationChange);
handleOrientationChange();
</script>
</body>
</html>