<!DOCTYPE html>
{% load static %}
<html class="h-full" data-kt-theme="true" data-kt-theme-mode="light" dir="ltr" lang="en">
<head>
    <title>Health-Equipment</title>
    <meta charset="utf-8"/>
    <meta content="follow, index" name="robots"/>
    <link href="home.html" rel="canonical"/>
    <link href="product-details.html" rel="canonical"/>
    <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport"/>
    <meta content="Home with store client management, powered by Tailwind CSS" name="description"/>
    <meta content="@keenthemes" name="twitter:site"/>
    <meta content="@keenthemes" name="twitter:creator"/>
    <meta content="summary_large_image" name="twitter:card"/>
    <meta content="Metronic - Tailwind CSS Home" name="twitter:title"/>
    <meta content="Home with store client management, powered by Tailwind CSS" name="twitter:description"/>
    <meta content="/static/metronic/tailwind/dist/assets/media/app/og-image.png" name="twitter:image"/>
    <meta content="https://keenthemes.com/metronic/tailwind/demo10/store-client/home" property="og:url"/>
    <meta content="en_US" property="og:locale"/>
    <meta content="website" property="og:type"/>
    <meta content="@keenthemes" property="og:site_name"/>
    <meta content="Metronic - Tailwind CSS Home" property="og:title"/>
    <meta content="Home with store client management, powered by Tailwind CSS" property="og:description"/>
    <meta content="/static/metronic/tailwind/dist/assets/media/app/og-image.png" property="og:image"/>
    <link href="{% static 'metronic/tailwind/dist/assets/media/brand-logos/health_logo.jpg' %}" rel="apple-touch-icon" sizes="180x180"/>
    <link href="{% static 'metronic/tailwind/dist/assets/media/brand-logos/health_logo.jpg' %}" rel="icon" sizes="32x32" type="image/png"/>
    <link href="{% static 'metronic/tailwind/dist/assets/media/brand-logos/health_logo.jpg' %}" rel="icon" sizes="16x16" type="image/png"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <!-- Toastify CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <link href="{% static 'metronic/tailwind/dist/assets/media/brand-logos/health_logo.jpg' %}" rel="shortcut icon"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="../../../../static/metronic/tailwind/dist/assets/vendors/apexcharts/apexcharts.css" rel="stylesheet"/>
    <link href="../../../../static/metronic/tailwind/dist/assets/vendors/keenicons/styles.bundle.css" rel="stylesheet"/>
    <link href="../../../../static/metronic/tailwind/dist/assets/css/styles.css" rel="stylesheet"/>
    <!-- Google tag (gtag.js) -->
    <style>
      .rounded-toast {
        border-radius: 20px !important;
        padding: 12px 16px !important;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      }
      .load-more-btn-popup {
        background: #fff;
        border: 1px solid #dc3545;
        color: #dc3545;
        padding: 6px 12px;
        border-radius: 15px;
        font-size: 12px;
        cursor: pointer;
        margin: 8px auto;
        display: block;
        transition: all 0.3s;
      }
      
      .load-more-btn-popup:hover:not(:disabled) {
        background: #dc3545;
        color: #fff;
      }
      
      .load-more-btn-popup:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      
      .load-more-btn-popup .spinner {
        display: none;
        width: 12px;
        height: 12px;
        border: 2px solid #dc3545;
        border-top-color: transparent;
        border-radius: 50%;
        animation: spin-popup 0.6s linear infinite;
        margin-right: 6px;
        vertical-align: middle;
      }
      
      .load-more-btn-popup.loading .spinner {
        display: inline-block;
      }
      
      .load-more-btn-popup.loading {
        background: #fff;
        color: #dc3545;
      }
      
      @keyframes spin-popup {
        to { transform: rotate(360deg); }
      }
    </style>

    
    <script async src="https://www.googletagmanager.com/gta
g/js?id=G-52YZ3XGZJ6"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-52YZ3XGZJ6');
    </script>
</head>
<body class="mt-5 py-5">
<!-- Theme Mode -->
<script>
    const defaultThemeMode = 'light';
    let themeMode;
    if (document.documentElement) {
        if (localStorage.getItem('kt-theme')) {
            themeMode = localStorage.getItem('kt-theme');
        } else if (document.documentElement.hasAttribute('data-kt-theme-mode')) {
            themeMode = document.documentElement.getAttribute('data-kt-theme-mode');
        } else {
            themeMode = defaultThemeMode;
        }
        if (themeMode === 'system') {
            themeMode = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }
        document.documentElement.classList.add(themeMode);
    }
</script>
<!-- End of Theme Mode -->
<!-- Message -->
{% if messages %}
  <script>
  document.addEventListener('DOMContentLoaded', function () {
    {% for message in messages %}
      Toastify({
        text: "{{ message|escapejs }}",
        duration: 5000,
        close: true,
        gravity: "top",
        position: "right",
        backgroundColor: "{% if message.tags == 'error' %}#ef4444{% elif message.tags == 'success' %}#10b981{% else %}#3b82f6{% endif %}",
        className: "rounded-toast"
      }).showToast();
    {% endfor %}
  });
  </script>
{% endif %}
<!-- End of Message -->
<!-- Page -->
<div class="flex grow mt-5 py-5">
    <!-- Header -->
    <header class="flex lg:hidden items-center fixed z-10 top-0 start-0 end-0 shrink-0 bg-mono dark:bg-background h-(--header-height)" id="header">
        <div class="kt-container-fixed flex items-center justify-between flex-wrap gap-3">
            <a href="#">
                <img class="size-[34px]" src="{% static 'metronic/tailwind/dist/assets/media/brand-logos/health_logo.jpg' %}"/>
            </a>
            <button class="kt-btn kt-btn-icon kt-btn-dim hover:text-white -me-2" data-kt-drawer-toggle="#sidebar">
                <i class="ki-filled ki-menu"></i>
            </button>
        </div>
    </header>
    <!-- Wrapper -->
    <div class="flex flex-col lg:flex-row grow pt-(--header-height) lg:pt-0">
        <!-- Sidebar -->
        {% include "pages/header.html" %}
        <!-- Main -->
        <div class="kt-container-fixed max-w-full mt-7 py-6">
            <!-- begin: Content -->
            {% block content %}{% endblock content %}
            <!-- end: Content -->
        </div>
    </div>
</div>
<!-- Floating Chat Button -->
<div id="kt_floating_btn"style="display:none;position:fixed;
        bottom:20px;
        right:20px;
        width:50px;
        height:50px;
        background:#dc3545;
        border-radius:50%;
        z-index:1050;
        cursor:pointer;
        display:flex;
        align-items:center;
        justify-content:center;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        transition: transform 0.2s ease;
     "
     onmouseover="this.style.transform='scale(1.1)'"
     onmouseout="this.style.transform='scale(1)'"
>
    {% if request.resolver_match.url_name == 'product_detail' and chat_room_id %}
        <i class="bi bi-chat-dots-fill text-white fs-4"></i>
    {% else %}
        <i class="bi bi-arrow-up text-white fs-4"></i>
    {% endif %}
</div>

<!-- Chat Popup Box -->
<div id="chatBox"
     style="
        position:fixed;
        bottom:80px;
        right:20px;
        width:320px;
        height:420px;
        background:#fff;
        border-radius:12px;
        box-shadow:0 10px 30px rgba(0,0,0,0.15);
        display:none;
        flex-direction:column;
        z-index:2000;
        overflow:hidden;
        font-family:Arial, sans-serif;
        transition: all 0.3s ease;
     "
>
    <!-- Header -->
    <div style="
            background:#dc3545;
            color:#fff;
            padding:12px 15px;
            display:flex;
            justify-content:space-between;
            align-items:center;
            font-weight:600;
            font-size:16px;
        ">
        <span>Chat with Supplier</span>
        <button id="closeChat"
                style="
                    background:none;
                    border:none;
                    color:#fff;
                    font-size:20px;
                    cursor:pointer;
                "
        >&times;</button>
    </div>

    <!-- Chat Body -->
    <div class="chat-body" style="
            flex:1;
            padding:12px;
            overflow-y:auto;
            background:#f8f9fa;
            display:flex;
            flex-direction:column;
            gap:8px;
        ">
        <!-- Load More Button -->
        <button class="load-more-btn-popup" id="loadMoreBtnPopup" style="display:none;">
            <span class="spinner"></span>
            <span class="btn-text">Load More</span>
        </button>
    </div>

    <!-- Input Box -->
    <div style="
            display:flex;
            border-top:1px solid #ddd;
            padding:10px;
            background:#fff;
        ">
        <input type="text"
               id="chatInput"
               placeholder="Type your message..."
               style="
                    flex:1;
                    border:1px solid #ddd;
                    border-radius:20px;
                    padding:8px 12px;
                    outline:none;
                    font-size:14px;
                "
        />
        <button id="sendBtn"
                style="
                    background:#dc3545;
                    border:none;
                    color:#fff;
                    border-radius:50%;
                    width:38px;
                    height:38px;
                    margin-left:8px;
                    cursor:pointer;
                    display:flex;
                    align-items:center;
                    justify-content:center;
                "
        >
            <i class="bi bi-send-fill"></i>
        </button>
    </div>
</div>

<!-- Include Footer -->
{% include 'pages/footer.html' %}
<!-- Scripts -->
<!-- Toastify JS -->
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js"></script>
<script src="{% static 'metronic/tailwind/dist/assets/js/core.bundle.js' %}"></script>
<script src="{% static 'metronic/tailwind/dist/assets/vendors/ktui/ktui.min.js' %}"></script>
<script src="{% static 'metronic/tailwind/dist/assets/vendors/apexcharts/apexcharts.min.js' %}"></script>
<!-- Scroll to Top Logic -->
<script>
    (function () {
        const btn = document.getElementById("kt_floating_btn");
        const chatBox = document.getElementById("chatBox");
        const closeChat = document.getElementById("closeChat");
    
        const isProductDetail = "{{ request.resolver_match.url_name }}" === "product_detail";
        const chatRoomId = "{{ chat_room_id|default:'' }}";
    
        if (!btn) return;
    
        window.addEventListener("scroll", function () {
            btn.style.display = window.scrollY > 300 ? "flex" : "none";
        });
    
        let chatSocket = null;
        let currentUserId = {{ user.id|default:0 }};
        let loadedMessagesCount = 0;
        let totalMessagesCount = 0;
        let hasMoreMessages = false;
        let isLoadingMore = false;
    
        btn.addEventListener("click", function (e) {
            e.preventDefault();
    
            if (isProductDetail && chatRoomId) {
                chatBox.style.display = "flex";
    
                if (!chatSocket || chatSocket.readyState === WebSocket.CLOSED) {
                    const ws_scheme = window.location.protocol === "https:" ? "wss" : "ws";
                    chatSocket = new WebSocket(
                        ws_scheme + '://' + window.location.host + '/ws/chat/' + chatRoomId + '/'
                    );
    
                    const chatBody = chatBox.querySelector(".chat-body");
                    const chatInput = document.getElementById("chatInput");
                    const sendBtn = document.getElementById("sendBtn");
                    const loadMoreBtn = document.getElementById("loadMoreBtnPopup");
    
                    chatSocket.onopen = function() {
                        console.log('WebSocket connected');
                        loadedMessagesCount = 0;
                    };
    
                    chatSocket.onmessage = function(e) {
                        const data = JSON.parse(e.data);
                        
                        if (data.type === 'chat_history') {
                            // Clear only messages, keep load more button
                            const messages = chatBody.querySelectorAll('.chat-message');
                            messages.forEach(msg => msg.remove());
                            
                            loadedMessagesCount = data.messages.length;
                            totalMessagesCount = data.total_count;
                            hasMoreMessages = data.has_more;
                            
                            data.messages.forEach(msg => {
                                appendMessage(msg);
                            });
                            
                            updateLoadMoreButton();
                            scrollToBottom();
                            
                        } else if (data.type === 'load_more_response') {
                            const previousScrollHeight = chatBody.scrollHeight;
                            
                            loadedMessagesCount += data.messages.length;
                            totalMessagesCount = data.total_count;
                            hasMoreMessages = data.has_more;
                            
                            // Prepend older messages
                            data.messages.reverse().forEach(msg => {
                                prependMessage(msg);
                            });
                            
                            // Maintain scroll position
                            const newScrollHeight = chatBody.scrollHeight;
                            chatBody.scrollTop = newScrollHeight - previousScrollHeight;
                            
                            updateLoadMoreButton();
                            isLoadingMore = false;
                            
                        } else if (data.type === 'message') {
                            appendMessage(data);
                            scrollToBottom();
                        }
                    };
    
                    chatSocket.onerror = function(error) {
                        console.error('WebSocket error:', error);
                    };
    
                    chatSocket.onclose = function() {
                        console.log('WebSocket closed');
                    };
                    
                    function updateLoadMoreButton() {
                        if (hasMoreMessages) {
                            loadMoreBtn.style.display = 'block';
                            loadMoreBtn.disabled = false;
                            loadMoreBtn.classList.remove('loading');
                            loadMoreBtn.querySelector('.btn-text').textContent = `Load More (${totalMessagesCount - loadedMessagesCount})`;
                        } else {
                            loadMoreBtn.style.display = 'none';
                        }
                    }
                    
                    function loadMoreMessages() {
                        if (isLoadingMore || !hasMoreMessages) return;
                        
                        isLoadingMore = true;
                        loadMoreBtn.disabled = true;
                        loadMoreBtn.classList.add('loading');
                        loadMoreBtn.querySelector('.btn-text').textContent = 'Loading...';
                        
                        if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
                            chatSocket.send(JSON.stringify({
                                'type': 'load_more',
                                'offset': loadedMessagesCount
                            }));
                        } else {
                            isLoadingMore = false;
                            updateLoadMoreButton();
                        }
                    }
                    
                    loadMoreBtn.onclick = loadMoreMessages;
                    
                    function prependMessage(data) {
                        const msgDiv = createMessageElement(data);
                        const firstMessage = chatBody.querySelector('.chat-message');
                        if (firstMessage) {
                            chatBody.insertBefore(msgDiv, firstMessage);
                        } else {
                            chatBody.appendChild(msgDiv);
                        }
                    }
    
                    function appendMessage(data) {
                        const msgDiv = createMessageElement(data);
                        chatBody.appendChild(msgDiv);
                    }
                    
                    function createMessageElement(data) {
                        const msgDiv = document.createElement('div');
                        msgDiv.className = 'chat-message';
                        const isCurrentUser = data.sender_id === currentUserId;
                        const isSystem = data.is_system || false;
                        
                        msgDiv.style.marginBottom = '10px';
                        msgDiv.style.padding = '8px 12px';
                        msgDiv.style.borderRadius = '10px';
                        msgDiv.style.maxWidth = '80%';
                        msgDiv.style.wordWrap = 'break-word';
                        
                        if (isSystem) {
                            msgDiv.style.background = '#f0f0f0';
                            msgDiv.style.color = '#666';
                            msgDiv.style.fontSize = '12px';
                            msgDiv.style.textAlign = 'center';
                            msgDiv.style.margin = '10px auto';
                            msgDiv.textContent = data.message;
                        } else {
                            if (isCurrentUser) {
                                msgDiv.style.background = '#dc3545';
                                msgDiv.style.color = '#fff';
                                msgDiv.style.alignSelf = 'flex-end';
                                msgDiv.style.marginLeft = 'auto';
                            } else {
                                msgDiv.style.background = '#e9ecef';
                                msgDiv.style.color = '#000';
                                msgDiv.style.alignSelf = 'flex-start';
                            }
                            
                            const senderSpan = document.createElement('div');
                            senderSpan.style.fontSize = '11px';
                            senderSpan.style.fontWeight = 'bold';
                            senderSpan.style.marginBottom = '4px';
                            senderSpan.textContent = data.sender;
                            
                            const messageSpan = document.createElement('div');
                            messageSpan.textContent = data.message;
                            
                            const timeSpan = document.createElement('div');
                            timeSpan.style.fontSize = '10px';
                            timeSpan.style.marginTop = '4px';
                            timeSpan.style.opacity = '0.7';
                            timeSpan.textContent = data.created_at;
                            
                            msgDiv.appendChild(senderSpan);
                            msgDiv.appendChild(messageSpan);
                            msgDiv.appendChild(timeSpan);
                        }
                        
                        return msgDiv;
                    }
                    
                    function scrollToBottom() {
                        chatBody.scrollTop = chatBody.scrollHeight;
                    }
    
                    function sendMessage() {
                        const message = chatInput.value.trim();
                        if (!message || !chatSocket || chatSocket.readyState !== WebSocket.OPEN) return;
                        
                        chatSocket.send(JSON.stringify({ message: message }));
                        chatInput.value = '';
                    }
    
                    sendBtn.onclick = sendMessage;
                    chatInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            sendMessage();
                        }
                    });
                }
            } else {
                window.scrollTo({ top: 0, behavior: "smooth" });
            }
        });
    
        closeChat.addEventListener("click", function () {
            chatBox.style.display = "none";
            if (chatSocket) {
                chatSocket.close();
                chatSocket = null;
            }
        });
    })();
</script>
</body>
</html>