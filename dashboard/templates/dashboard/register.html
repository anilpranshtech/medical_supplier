<!DOCTYPE html>
{% load static %}
<html class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>User Registration</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap');

        body {
            font-family: 'Nunito', sans-serif;
            background-image: url('https://storely-nextjs.keenthemes.com//media/images/2600x1200/bg-10.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        .dark body {
            background-image: url('https://storely-nextjs.keenthemes.com//media/images/2600x1200/bg-10-dark.png');
        }

        .register-container {
            background: #ffffff;
            padding: 2.5rem;
            border-radius: 1.5rem;
            width: 100%;
            max-width: 500px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .dark .register-container {
            background: #1f2937;
            border-color: #4b5563;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label {
            font-size: 0.875rem;
            color: #1e293b;
            margin-bottom: 0.375rem;
            display: block;
            font-weight: 600;
        }

        .dark .form-group label {
            color: #e5e7eb;
        }

        .input-field {
            width: 100%;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            background: #ffffff;
            border: 1px solid #D0D5DD;
            font-size: 1rem;
            color: #101828;
            transition: border 0.2s ease, box-shadow 0.2s ease;
        }

        .dark .input-field {
            background: #374151;
            border-color: #4b5563;
            color: #e5e7eb;
        }

        .input-field:focus {
            border-color: #0ea5e9;
            box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.15);
            outline: none;
        }

        .input-error {
            border-color: #F04438 !important;
        }

        .password-input-container {
            position: relative;
        }

        .toggle-password {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #98A2B3;
            cursor: pointer;
        }

        .dark .toggle-password {
            color: #9ca3af;
        }

        .continue-btn, .create-btn, .verify-btn {
            width: 100%;
            background: #0ea5e9;
            color: white;
            padding: 0.75rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .continue-btn:hover, .create-btn:hover, .verify-btn:hover {
            background: #0284c7;
        }

        .back-btn {
            width: 100%;
            background: #f1f5f9;
            color: #64748b;
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
        }

        .dark .back-btn {
            background: #374151;
            border-color: #4b5563;
            color: #9ca3af;
        }

        .back-btn:hover {
            background: #e2e8f0;
        }

        .dark .back-btn:hover {
            background: #4b5563;
        }

        .signup-link {
            text-align: center;
            font-size: 0.875rem;
            margin-top: 1.25rem;
            color: #64748b;
        }

        .dark .signup-link {
            color: #9ca3af;
        }

        .signup-link a {
            color: #0ea5e9;
            font-weight: 600;
            text-decoration: none;
        }

        .signup-link a:hover {
            text-decoration: underline;
        }

        .error-message, .success-message {
            color: #F04438;
            font-size: 0.75rem;
            margin-top: 0.25rem;
            display: none;
        }

        .success-message {
            color: #22c55e;
        }

        .server-error {
            color: #F04438;
            font-size: 0.75rem;
            margin-bottom: 0.625rem;
            text-align: center;
        }

        .otp-input-container {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
        }

        .otp-input {
            width: 2.5rem;
            height: 2.5rem;
            text-align: center;
            font-size: 1.25rem;
            border-radius: 0.5rem;
            background: #f8fafc;
            border: 1px solid #cbd5e1;
            color: #0f172a;
        }

        .dark .otp-input {
            background: #374151;
            border-color: #4b5563;
            color: #e5e7eb;
        }

        .otp-input:focus {
            border-color: #0ea5e9;
            box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.15);
            outline: none;
        }

        .otp-input.input-error {
            border-color: #ef4444 !important;
        }

        .resend-link {
            color: #0ea5e9;
            font-size: 0.875rem;
            text-align: center;
            margin-bottom: 1rem;
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
        }

        .resend-link:hover {
            text-decoration: underline;
        }

        .resend-link.disabled {
            color: #64748b;
            cursor: not-allowed;
            text-decoration: none;
        }

        .role-toggle-btn {
            display: block;
            width: 100%;
            text-align: center;
            font-size: 1rem;
            font-weight: 600;
            color: #1570EF;
            text-decoration: none;
            cursor: pointer;
            padding: 0.75rem 0;
        }

        .dark .role-toggle-btn {
            color: #60a5fa;
        }

        .role-toggle-btn:hover {
            color: #0284c7;
        }

        .toggle-switch {
            position: relative;
            display: flex;
            width: 100%;
            background: #f1f5f9;
            border: 2px solid #e2e8f0;
            border-radius: 9999px;
            overflow: hidden;
            height: 50px;
        }

        .dark .toggle-switch {
            background: #374151;
            border-color: #4b5563;
        }

        .toggle-switch input[type="radio"] {
            display: none;
        }

        .toggle-switch label {
            flex: 1;
            cursor: pointer;
            text-align: center;
            line-height: 50px;
            font-weight: 600;
            font-size: 0.875rem;
            position: relative;
            z-index: 2;
            color: #64748b;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.375rem;
            transition: color 0.3s ease;
        }

        .dark .toggle-switch label {
            color: #9ca3af;
        }

        .toggle-switch input[type="radio"]:checked + label {
            color: #ffffff;
        }

        .toggle-switch .icon {
            width: 18px;
            height: 18px;
        }

        .toggle-switch input[type="radio"]#retailer:checked ~ .toggle-indicator {
            transform: translateX(0%);
        }

        .toggle-switch input[type="radio"]#wholesaler:checked ~ .toggle-indicator {
            transform: translateX(100%);
        }

        .toggle-indicator {
            position: absolute;
            height: 100%;
            width: 50%;
            background-color: #0284c7;
            border-radius: 9999px;
            top: 0;
            left: 0;
            z-index: 1;
            transition: transform 0.3s ease;
        }
    </style>
</head>
<body class="antialiased flex h-full text-base bg-background">
<div class="flex flex-col items-center justify-center grow bg-center bg-no-repeat mt-5">
    <div class="register-container mb-5">
        <h1 class="text-2xl font-bold tracking-tight text-center text-gray-700">Create Your Account</h1>

        <!-- Server-side errors -->
        {% if messages %}
            <div class="server-error">
                {% for message in messages %}
                    {{ message }}
                {% endfor %}
            </div>
        {% endif %}

        <!-- Registration Form -->
        <div id="registerSection">
            <form method="post" class="space-y-5" id="registerForm" novalidate>
                {% csrf_token %}
                <input type="hidden" name="user_type" id="user_type_input" value="{{ form_data.user_type|default:'buyer' }}">
                <input type="hidden" name="buyer_type" id="buyer_type_input" value="{{ form_data.buyer_type|default:'retailer' }}">

                <!-- Step 1 Fields -->
                <div id="step1Fields" class="space-y-4">
                    <div class="role-toggle mb-3">
                        <a href="#" id="supplierBtn" class="role-toggle-btn" style="text-decoration: underline;">
                            {% if form_data.user_type == 'supplier' %}Become a Buyer?{% else %}Become a Supplier?{% endif %}
                        </a>
                    </div>

                    <!-- Retailer/Wholesaler Toggle Switch -->
                    <div id="buyerOptions" class="toggle-switch {% if form_data.user_type == 'supplier' %}hidden{% endif %}">
                        <input type="radio" id="retailer" name="buyer_type" value="retailer" {% if form_data.buyer_type|default:'retailer' == 'retailer' %}checked{% endif %}>
                        <label for="retailer">
                            Retailer
                        </label>
                        <input type="radio" id="wholesaler" name="buyer_type" value="wholesaler" {% if form_data.buyer_type == 'wholesaler' %}checked{% endif %}>
                        <label for="wholesaler">
                            Wholesaler
                        </label>
                        <span class="toggle-indicator"></span>
                    </div>

                    <div class="form-group">
                        <label for="first_name">First Name</label>
                        <input type="text" name="first_name" id="first_name" class="input-field" placeholder="Your first name" value="{{ form_data.first_name|default_if_none:'' }}" required>
                        <div class="error-message" id="first_name_error">Please enter your first name</div>
                    </div>

                    <div class="form-group">
                        <label for="last_name">Last Name</label>
                        <input type="text" name="last_name" id="last_name" class="input-field" placeholder="Your last name" value="{{ form_data.last_name|default_if_none:'' }}" required>
                        <div class="error-message" id="last_name_error">Please enter your last name</div>
                    </div>

                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" name="email" id="email" class="input-field" placeholder="Your email" value="{{ form_data.email|default_if_none:'' }}" required>
                        <div class="error-message" id="email_error">Please enter a valid email address</div>
                    </div>

                    <div class="form-group">
                        <label for="phone">Phone Number</label>
                        <input type="tel" name="phone" id="phone" class="input-field" placeholder="Your phone number" value="{{ form_data.phone|default_if_none:'' }}" required>
                        <div class="error-message" id="phone_error">Please enter a valid phone number</div>
                    </div>

                    <div class="form-group">
                        <label for="password">Password</label>
                        <div class="password-input-container">
                            <input type="password" name="password" id="password" placeholder="Your password" class="input-field" required>
                            <button type="button" class="toggle-password" aria-label="Toggle password visibility">
                                <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M10 4.375C3.75 4.375 1.25 10 1.25 10C1.25 10 3.75 15.625 10 15.625C16.25 15.625 18.75 10 18.75 10C18.75 10 16.25 4.375 10 4.375Z"
                                          stroke="#98A2B3" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M10 13.125C11.7259 13.125 13.125 11.7259 13.125 10C13.125 8.27411 11.7259 6.875 10 6.875C8.27411 6.875 6.875 8.27411 6.875 10C6.875 11.7259 8.27411 13.125 10 13.125Z"
                                          stroke="#98A2B3" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </button>
                        </div>
                        <div class="error-message" id="password_error">Please enter a valid password</div>
                    </div>

                    <div class="form-group">
                        <label for="confirm_password">Confirm Password</label>
                        <div class="password-input-container">
                            <input type="password" name="confirm_password" id="confirm_password" placeholder="Confirm your password" class="input-field" required>
                            <button type="button" class="toggle-password" aria-label="Toggle password visibility">
                                <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M10 4.375C3.75 4.375 1.25 10 1.25 10C1.25 10 3.75 15.625 10 15.625C16.25 15.625 18.75 10 18.75 10C18.75 10 16.25 4.375 10 4.375Z"
                                          stroke="#98A2B3" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M10 13.125C11.7259 13.125 13.125 11.7259 13.125 10C13.125 8.27411 11.7259 6.875 10 6.875C8.27411 6.875 6.875 8.27411 6.875 10C6.875 11.7259 8.27411 13.125 10 13.125Z"
                                          stroke="#98A2B3" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </button>
                        </div>
                        <div class="error-message" id="confirm_password_error">Passwords do not match</div>
                    </div>

                    <div class="form-group">
                        <div class="g-recaptcha" data-sitekey="6LdTHV8rAAAAAM_YfllvwXXOezA124fFTlQXO3Tb"></div>
                        <div class="error-message" id="recaptcha_error">Please complete the captcha</div>
                    </div>

                    <button type="button" id="nextBtn" class="continue-btn">Continue</button>
                </div>

                <!-- Step 2 Fields -->
                <div id="step2Fields" class="space-y-4 hidden">
                    <div id="retailFields" class="user-fields hidden">
                        <div class="form-group">
                            <label for="current_position">Current Position</label>
                            <input type="text" name="current_position" id="current_position" placeholder="Your current position" value="{{ form_data.current_position|default_if_none:'' }}" class="input-field">
                            <div class="error-message" id="current_position_error">Please enter your current position</div>
                        </div>
                        <div class="form-group">
                            <label for="workplace">Workplace</label>
                            <input type="text" name="workplace" id="workplace" placeholder="Your workplace" value="{{ form_data.workplace|default_if_none:'' }}" class="input-field">
                            <div class="error-message" id="workplace_error">Please enter your workplace</div>
                        </div>
                        <div class="form-group">
                            <label for="nationality">Nationality</label>
                            <select name="nationality" id="nationality" class="input-field">
                                <option value="">Select your nationality</option>
                                {% for nationality in nationalities %}
                                    <option value="{{ nationality.id }}" {% if form_data.nationality|add:0 == nationality.id %}selected{% endif %}>{{ nationality.country }}</option>
                                {% endfor %}
                            </select>
                            <div class="error-message" id="nationality_error">Please select a valid nationality</div>
                        </div>
                        <div class="form-group">
                            <label for="residency">Residency</label>
                            <select name="residency" id="residency" class="input-field">
                                <option value="">Select your residency</option>
                                {% for residency in residencies %}
                                    <option value="{{ residency.id }}" {% if form_data.residency|add:0 == residency.id %}selected{% endif %}>{{ residency.country }}</option>
                                {% endfor %}
                            </select>
                            <div class="error-message" id="residency_error">Please select a valid residency</div>
                        </div>
                        <div class="form-group">
                            <label for="country_code">Country Code</label>
                            <select name="country_code" id="country_code" class="input-field">
                                <option value="">Select your country code</option>
                                {% for code in country_codes %}
                                    <option value="{{ code.id }}" {% if form_data.country_code|add:0 == code.id %}selected{% endif %}>{{ code.code }} ({{ code.country }})</option>
                                {% endfor %}
                            </select>
                            <div class="error-message" id="country_code_error">Please select a valid country code</div>
                        </div>
                        <div class="form-group">
                            <label for="speciality">Speciality</label>
                            <select name="speciality" id="speciality" class="input-field">
                                <option value="">Select your speciality</option>
                                {% for speciality in specialities %}
                                    <option value="{{ speciality.id }}" {% if form_data.speciality|add:0 == speciality.id %}selected{% endif %}>{{ speciality.name }}</option>
                                {% endfor %}
                            </select>
                            <div class="error-message" id="speciality_error">Please select a valid speciality</div>
                        </div>
                    </div>

                    <div id="wholesalerFields" class="user-fields hidden">
                        <div class="form-group">
                            <label for="company_name">Company Name</label>
                            <input type="text" name="company_name" id="company_name" placeholder="Your company name" value="{{ form_data.company_name|default_if_none:'' }}" class="input-field">
                            <div class="error-message" id="company_name_error">Please enter your company name</div>
                        </div>
                        <div class="form-group">
                            <label for="gst_number">GST Number</label>
                            <input type="text" name="gst_number" id="gst_number" placeholder="Your GST number" value="{{ form_data.gst_number|default_if_none:'' }}" class="input-field">
                            <div class="error-message" id="gst_number_error">Please enter a valid GST number</div>
                        </div>
                        <div class="form-group">
                            <label for="department">Department</label>
                            <input type="text" name="department" id="department" placeholder="Your department" value="{{ form_data.department|default_if_none:'' }}" class="input-field">
                            <div class="error-message" id="department_error">Please enter your department</div>
                        </div>
                        <div class="form-group">
                            <label for="purchase_capacity">Purchase Capacity</label>
                            <input type="text" name="purchase_capacity" id="purchase_capacity" placeholder="Your purchase capacity" value="{{ form_data.purchase_capacity|default_if_none:'' }}" class="input-field">
                            <div class="error-message" id="purchase_capacity_error">Please enter a valid number</div>
                        </div>
                    </div>

                    <div id="supplierFields" class="user-fields hidden">
                        <div class="form-group">
                            <label for="supplier_company_name">Company Name</label>
                            <input type="text" name="supplier_company_name" id="supplier_company_name" placeholder="Your company name" value="{{ form_data.supplier_company_name|default_if_none:'' }}" class="input-field">
                            <div class="error-message" id="supplier_company_name_error">Please enter your company name</div>
                        </div>
                        <div class="form-group">
                            <label for="license_number">License Number</label>
                            <input type="text" name="license_number" id="license_number" placeholder="Your license number" value="{{ form_data.license_number|default_if_none:'' }}" class="input-field">
                            <div class="error-message" id="license_number_error">Please enter a valid license number</div>
                        </div>
                    </div>

                    <div class="flex gap-4">
                        <button type="button" id="backBtn" class="back-btn">Back</button>
                        <button type="submit" class="create-btn">Create Account</button>
                    </div>
                </div>

                <div class="signup-link">
                    Already have an account? <a href="{% url 'dashboard:login' %}">Sign in</a>
                </div>
            </form>
        </div>

        <!-- OTP Section -->
        <div id="otpSection" class="hidden">
            <div class="otp-header">
                <h3 class="text-2xl font-semibold tracking-tight text-center text-gray-700 dark:text-gray-200">Verify OTP</h3>
                <p class="text-center text-gray-600 dark:text-gray-400">Enter the OTP sent to your mobile number.</p>
            </div>
            <div id="message" class="error-message"></div>
            <form id="otpForm" class="flex flex-col gap-4">
                {% csrf_token %}
                <div class="form-group">
                    <label for="otp">OTP</label>
                    <div class="otp-input-container">
                        <input class="otp-input" type="text" maxlength="1" pattern="[0-9]" required>
                        <input class="otp-input" type="text" maxlength="1" pattern="[0-9]" required>
                        <input class="otp-input" type="text" maxlength="1" pattern="[0-9]" required>
                        <input class="otp-input" type="text" maxlength="1" pattern="[0-9]" required>
                        <input class="otp-input" type="text" maxlength="1" pattern="[0-9]" required>
                        <input class="otp-input" type="text" maxlength="1" pattern="[0-9]" required>
                    </div>
                    <div class="error-message" id="otp_error">Please enter a valid 6-digit OTP</div>
                    <input type="hidden" name="otp" id="otp">
                </div>
                <div class="resend-link" id="resend-otp">Resend OTP</div>
                <button type="submit" class="verify-btn">Verify</button>
            </form>
        </div>
    </div>
</div>

<script>
    // Form elements
    const supplierBtn = document.getElementById("supplierBtn");
    const buyerOptions = document.getElementById("buyerOptions");
    const userTypeInput = document.getElementById("user_type_input");
    const buyerTypeInput = document.getElementById("buyer_type_input");
    const nextBtn = document.getElementById("nextBtn");
    const backBtn = document.getElementById("backBtn");
    const step1 = document.getElementById("step1Fields");
    const step2 = document.getElementById("step2Fields");
    const retailFields = document.getElementById("retailFields");
    const wholesalerFields = document.getElementById("wholesalerFields");
    const supplierFields = document.getElementById("supplierFields");

    // Step 1 fields
    const firstNameInput = document.getElementById("first_name");
    const lastNameInput = document.getElementById("last_name");
    const emailInput = document.getElementById("email");
    const phoneInput = document.getElementById("phone");
    const passwordInput = document.getElementById("password");
    const confirmPasswordInput = document.getElementById("confirm_password");

    // Step 1 error messages
    const firstNameError = document.getElementById("first_name_error");
    const lastNameError = document.getElementById("last_name_error");
    const emailError = document.getElementById("email_error");
    const phoneError = document.getElementById("phone_error");
    const passwordError = document.getElementById("password_error");
    const confirmPasswordError = document.getElementById("confirm_password_error");
    const recaptchaError = document.getElementById("recaptcha_error");

    // Step 2 fields
    const currentPositionInput = document.getElementById("current_position");
    const workplaceInput = document.getElementById("workplace");
    const nationalityInput = document.getElementById("nationality");
    const residencyInput = document.getElementById("residency");
    const countryCodeInput = document.getElementById("country_code");
    const specialityInput = document.getElementById("speciality");
    const companyNameInput = document.getElementById("company_name");
    const gstNumberInput = document.getElementById("gst_number");
    const departmentInput = document.getElementById("department");
    const purchaseCapacityInput = document.getElementById("purchase_capacity");
    const supplierCompanyNameInput = document.getElementById("supplier_company_name");
    const licenseNumberInput = document.getElementById("license_number");

    // Step 2 error messages
    const currentPositionError = document.getElementById("current_position_error");
    const workplaceError = document.getElementById("workplace_error");
    const nationalityError = document.getElementById("nationality_error");
    const residencyError = document.getElementById("residency_error");
    const countryCodeError = document.getElementById("country_code_error");
    const specialityError = document.getElementById("speciality_error");
    const companyNameError = document.getElementById("company_name_error");
    const gstNumberError = document.getElementById("gst_number_error");
    const departmentError = document.getElementById("department_error");
    const purchaseCapacityError = document.getElementById("purchase_capacity_error");
    const supplierCompanyNameError = document.getElementById("supplier_company_name_error");
    const licenseNumberError = document.getElementById("license_number_error");

    let isSupplier = userTypeInput.value === "supplier";

    // Toggle supplier/buyer
    supplierBtn.addEventListener("click", (e) => {
        e.preventDefault();
        isSupplier = !isSupplier;
        supplierBtn.textContent = isSupplier ? "Become a Buyer?" : "Become a Supplier?";
        buyerOptions.classList.toggle("hidden", isSupplier);
        userTypeInput.value = isSupplier ? "supplier" : "buyer";
    });

    // Handle buyer type selection (Retailer/Wholesaler)
    document.querySelectorAll('input[name="buyer_type"]').forEach(radio => {
        radio.addEventListener('change', () => {
            buyerTypeInput.value = radio.value;
            if (!isSupplier) {
                retailFields.classList.toggle('hidden', radio.value !== 'retailer');
                wholesalerFields.classList.toggle('hidden', radio.value !== 'wholesaler');
            }
        });
    });

    // Set initial visibility
    if (isSupplier) {
        buyerOptions.classList.add('hidden');
        supplierFields.classList.remove('hidden');
        retailFields.classList.add('hidden');
        wholesalerFields.classList.add('hidden');
    } else {
        const buyerType = buyerTypeInput.value || 'retailer';
        retailFields.classList.toggle('hidden', buyerType !== 'retailer');
        wholesalerFields.classList.toggle('hidden', buyerType !== 'wholesaler');
        supplierFields.classList.add('hidden');
    }

    // Client-side validation for Step 1
    nextBtn.addEventListener("click", () => {
        let isValid = true;

        // Reset error states
        [firstNameInput, lastNameInput, emailInput, phoneInput, passwordInput, confirmPasswordInput].forEach(input => input.classList.remove("input-error"));
        [firstNameError, lastNameError, emailError, phoneError, passwordError, confirmPasswordError, recaptchaError].forEach(error => error.style.display = "none");

        if (!firstNameInput.value.trim()) {
            firstNameInput.classList.add("input-error");
            firstNameError.style.display = "block";
            isValid = false;
        }

        if (!lastNameInput.value.trim()) {
            lastNameInput.classList.add("input-error");
            lastNameError.style.display = "block";
            isValid = false;
        }

        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailInput.value.trim() || !emailRegex.test(emailInput.value)) {
            emailInput.classList.add("input-error");
            emailError.style.display = "block";
            isValid = false;
        }

        const phoneRegex = /^\+?[1-9]\d{1,14}$/;
        if (!phoneInput.value.trim() || !phoneRegex.test(phoneInput.value)) {
            phoneInput.classList.add("input-error");
            phoneError.style.display = "block";
            isValid = false;
        }

        if (!passwordInput.value.trim()) {
            passwordInput.classList.add("input-error");
            passwordError.style.display = "block";
            isValid = false;
        } else if (passwordInput.value.length < 8) {
            passwordInput.classList.add("input-error");
            passwordError.textContent = "Password must be at least 8 characters";
            passwordError.style.display = "block";
            isValid = false;
        }

        if (!confirmPasswordInput.value.trim() || confirmPasswordInput.value !== passwordInput.value) {
            confirmPasswordInput.classList.add("input-error");
            confirmPasswordError.style.display = "block";
            isValid = false;
        }

        const recaptchaResponse = grecaptcha.getResponse();
        if (!recaptchaResponse) {
            recaptchaError.style.display = "block";
            isValid = false;
        }

        if (isValid) {
            step1.classList.add("hidden");
            step2.classList.remove("hidden");
            if (isSupplier) {
                supplierFields.classList.remove("hidden");
                retailFields.classList.add("hidden");
                wholesalerFields.classList.add("hidden");
            } else {
                const buyerType = buyerTypeInput.value || "retailer";
                retailFields.classList.toggle("hidden", buyerType !== "retailer");
                wholesalerFields.classList.toggle("hidden", buyerType !== "wholesaler");
                supplierFields.classList.add("hidden");
            }
        }
    });

    // Back button
    backBtn.addEventListener("click", () => {
        step2.classList.add("hidden");
        step1.classList.remove("hidden");
    });

    // Password visibility toggle
    document.querySelectorAll('.toggle-password').forEach(button => {
        button.addEventListener('click', () => {
            const input = button.parentElement.querySelector('input');
            const type = input.type === 'password' ? 'text' : 'password';
            input.type = type;
            const svg = button.querySelector('svg');
            svg.innerHTML = type === 'text' ?
                `<path d="M10 4.375C3.75 4.375 1.25 10 1.25 10C1.25 10 3.75 15.625 10 15.625C16.25 15.625 18.75 10 18.75 10C18.75 10 16.25 4.375 10 4.375Z" stroke="#98A2B3" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                 <path d="M2.5 2.5L17.5 17.5" stroke="#98A2B3" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                 <path d="M7.975 7.975C7.37083 8.57917 7.08333 9.375 7.08333 10C7.08333 11.7259 8.47411 13.125 10 13.125C10.625 13.125 11.4208 12.8375 12.025 12.2333" stroke="#98A2B3" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>` :
                `<path d="M10 4.375C3.75 4.375 1.25 10 1.25 10C1.25 10 3.75 15.625 10 15.625C16.25 15.625 18.75 10 18.75 10C18.75 10 16.25 4.375 10 4.375Z" stroke="#98A2B3" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                 <path d="M10 13.125C11.7259 13.125 13.125 11.7259 13.125 10C13.125 8.27411 11.7259 6.875 10 6.875C8.27411 6.875 6.875 8.27411 6.875 10C6.875 11.7259 8.27411 13.125 10 13.125Z" stroke="#98A2B3" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>`;
        });
    });

    // OTP input handling
    const otpInputs = document.querySelectorAll('.otp-input');
    const otpHidden = document.getElementById("otp");
    const otpError = document.getElementById("otp_error");
    const resendLink = document.getElementById("resend-otp");
    const messageDiv = document.getElementById("message");

    otpInputs.forEach((input, index) => {
        input.addEventListener('input', (e) => {
            if (!/^[0-9]$/.test(e.target.value)) {
                e.target.value = '';
                return;
            }
            if (e.target.value && index < otpInputs.length - 1) {
                otpInputs[index + 1].focus();
            }
            updateHiddenOTP();
        });

        input.addEventListener('keydown', (e) => {
            if (e.key === 'Backspace' && !e.target.value && index > 0) {
                otpInputs[index - 1].focus();
            }
        });

        input.addEventListener('paste', (e) => {
            e.preventDefault();
            const pasteData = e.clipboardData.getData('text').replace(/\D/g, '');
            if (pasteData.length <= 6) {
                for (let i = 0; i < pasteData.length && i < otpInputs.length; i++) {
                    otpInputs[i].value = pasteData[i];
                    if (i < otpInputs.length - 1) {
                        otpInputs[i + 1].focus();
                    }
                }
                updateHiddenOTP();
            }
        });
    });

    function updateHiddenOTP() {
        otpHidden.value = Array.from(otpInputs).map(input => input.value).join('');
    }

    // jQuery AJAX for registration and OTP verification
    let regToken = null;

    $('#registerForm').submit(function (e) {
        e.preventDefault();
        $('.error-message').hide();
        $('.input-field').removeClass('input-error');
        messageDiv.style.display = 'none';

        // Client-side validation for Step 2
        let isValid = true;
        [currentPositionInput, workplaceInput, companyNameInput, gstNumberInput, departmentInput, purchaseCapacityInput, supplierCompanyNameInput, licenseNumberInput].forEach(input => {
            if (input) input.classList.remove("input-error");
        });
        [currentPositionError, workplaceError, companyNameError, gstNumberError, departmentError, purchaseCapacityError, supplierCompanyNameError, licenseNumberError].forEach(error => {
            if (error) error.style.display = "none";
        });

        if (!wholesalerFields.classList.contains("hidden")) {
            if (!companyNameInput.value.trim()) {
                companyNameInput.classList.add("input-error");
                companyNameError.style.display = "block";
                isValid = false;
            }
            if (!gstNumberInput.value.trim()) {
                gstNumberInput.classList.add("input-error");
                gstNumberError.style.display = "block";
                isValid = false;
            }
            if (!departmentInput.value.trim()) {
                departmentInput.classList.add("input-error");
                departmentError.style.display = "block";
                isValid = false;
            }
            if (!purchaseCapacityInput.value.trim() || isNaN(parseInt(purchaseCapacityInput.value))) {
                purchaseCapacityInput.classList.add("input-error");
                purchaseCapacityError.style.display = "block";
                isValid = false;
            }
        }

        if (!supplierFields.classList.contains("hidden")) {
            if (!supplierCompanyNameInput.value.trim()) {
                supplierCompanyNameInput.classList.add("input-error");
                supplierCompanyNameError.style.display = "block";
                isValid = false;
            }
            if (!licenseNumberInput.value.trim()) {
                licenseNumberInput.classList.add("input-error");
                licenseNumberError.style.display = "block";
                isValid = false;
            }
        }

        if (!isValid) return;

        $.ajax({
            url: "{% url 'dashboard:register' %}",
            type: "POST",
            data: $(this).serialize() + "&step=register",
            headers: { 'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val() },
            success: function (res) {
                if (res.success) {
                    regToken = res.token;
                    $('#registerSection').hide();
                    $('#otpSection').show();
                }
            },
            error: function (xhr) {
                const errors = xhr.responseJSON.errors;
                for (const key in errors) {
                    const errorEl = $(`#${key}_error`);
                    const inputEl = $(`#${key}`);
                    if (errorEl.length) {
                        errorEl.text(errors[key]).show();
                    }
                    if (inputEl.length) {
                        inputEl.addClass('input-error');
                    }
                }
                if (errors.general) {
                    messageDiv.textContent = errors.general;
                    messageDiv.className = 'error-message';
                    messageDiv.style.display = 'block';
                    setTimeout(() => messageDiv.style.display = 'none', 5000);
                }
            }
        });
    });

    $('#otpForm').submit(function (e) {
        e.preventDefault();
        const otpValue = $('#otp').val();
        $('.otp-input').removeClass('input-error');
        otpError.style.display = 'none';
        messageDiv.style.display = 'none';

        if (!otpValue || otpValue.length !== 6) {
            $('.otp-input').addClass('input-error');
            otpError.style.display = 'block';
            return;
        }

        if (!regToken) {
            messageDiv.textContent = 'Registration token is missing. Please try registering again.';
            messageDiv.className = 'error-message';
            messageDiv.style.display = 'block';
            setTimeout(() => messageDiv.style.display = 'none', 5000);
            return;
        }

        $.ajax({
            url: "{% url 'dashboard:register' %}",
            type: "POST",
            data: { step: 'verify_otp', token: regToken, otp: otpValue },
            headers: { 'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val() },
            success: function (res) {
                if (res.success) {
                    messageDiv.textContent = 'Account created successfully!';
                    messageDiv.className = 'success-message';
                    messageDiv.style.display = 'block';
                    setTimeout(() => window.location.href = res.redirect, 2000);
                }
            },
            error: function (xhr) {
                $('.otp-input').addClass('input-error');
                const errors = xhr.responseJSON.errors;
                if (errors.otp) {
                    otpError.textContent = errors.otp;
                    otpError.style.display = 'block';
                } else if (errors.general) {
                    messageDiv.textContent = errors.general;
                    messageDiv.className = 'error-message';
                    messageDiv.style.display = 'block';
                }
                setTimeout(() => {
                    otpError.style.display = 'none';
                    messageDiv.style.display = 'none';
                }, 5000);
            }
        });
    });

    // Resend OTP
    let isResendDisabled = false;
    resendLink.addEventListener('click', () => {
        if (isResendDisabled || !regToken) return;
        isResendDisabled = true;
        resendLink.classList.add('disabled');
        resendLink.textContent = 'Resending...';

        $.ajax({
            url: '{% url "dashboard:resend_otp" %}',
            type: 'POST',
            data: { token: regToken },
            headers: { 'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val() },
            success: function (res) {
                messageDiv.textContent = res.message || 'OTP resent successfully';
                messageDiv.className = res.message.includes('successfully') ? 'success-message' : 'error-message';
                messageDiv.style.display = 'block';
                setTimeout(() => messageDiv.style.display = 'none', 5000);
                setTimeout(() => {
                    isResendDisabled = false;
                    resendLink.classList.remove('disabled');
                    resendLink.textContent = 'Resend OTP';
                }, 30000);
            },
            error: function () {
                messageDiv.textContent = 'Failed to resend OTP. Please try again.';
                messageDiv.className = 'error-message';
                messageDiv.style.display = 'block';
                setTimeout(() => messageDiv.style.display = 'none', 5000);
                setTimeout(() => {
                    isResendDisabled = false;
                    resendLink.classList.remove('disabled');
                    resendLink.textContent = 'Resend OTP';
                }, 30000);
            }
        });
    });
</script>
</body>
</html>