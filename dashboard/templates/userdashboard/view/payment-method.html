{% extends "pages/base.html" %}
{% load static %}

{% block content %}
<div class="kt-container-fixed mt-5 py-5" style="max-width: var(--custom-container-width, 85%);">
    <div class="flex flex-col items-stretch gap-7 mt-5 py-5">
        <main class="grow" role="content">
            <!-- Container -->
            <div class="kt-container-fixed">
                <div class="flex items-center justify-center flex-wrap lg:flex-nowrap gap-8 lg:gap-1.5 pt-5 mb-12">
                    <!-- Step Button -->
                    <div class="text-2sm leading-none relative flex items-center gap-1.5 px-3 h-8.5 rounded-full border border-border text-foreground [&_.kt-step-icon]:text-muted-foreground bg-muted/30">
                        <i class="ki-solid ki-check-circle text-green-500 absolute -top-1 -end-1 text-base"></i>
                        <span class="kt-step-icon">
                            <i class="ki-filled ki-subtitle text-base"></i>
                        </span>
                        Order Summary
                    </div>
                    <div class="hidden lg:block w-12 h-px border-t border-dashed border-zinc-300 dark:border-zinc-600"></div>
                    <div class="text-2sm leading-none relative flex items-center gap-1.5 px-3 h-8.5 rounded-full border border-border text-foreground [&_.kt-step-icon]:text-muted-foreground bg-muted/30">
                        <i class="ki-solid ki-check-circle text-green-500 absolute -top-1 -end-1 text-base"></i>
                        <span class="kt-step-icon">
                            <i class="ki-filled ki-delivery text-base"></i>
                        </span>
                        Shipping Info
                    </div>
                    <div class="hidden lg:block w-12 h-px border-t border-dashed border-zinc-300 dark:border-zinc-600"></div>
                    <div class="text-2sm leading-none relative flex items-center gap-1.5 px-3 h-8.5 rounded-full border font-medium border-primary/10 bg-primary/10 text-primary [&_.kt-step-icon]:text-primary">
                        <span class="kt-step-icon">
                            <i class="ki-filled ki-two-credit-cart text-base"></i>
                        </span>
                        Payment Method
                    </div>
                    <div class="hidden lg:block w-12 h-px border-t border-dashed border-zinc-300 dark:border-zinc-600"></div>
                    <div class="text-2sm leading-none relative flex items-center gap-1.5 px-3 h-8.5 rounded-full border border-border text-foreground [&_.kt-step-icon]:text-muted-foreground">
                        <span class="kt-step-icon">
                            <i class="ki-filled ki-cheque text-base"></i>
                        </span>
                        Order Placed
                    </div>
                </div>
            </div>
            <!-- Dropdown for payment selection -->
            <div class="kt-container-fixed mb-4">
                <div class="flex justify-end">
                    <div class="w-full sm:w-64">
                        <label for="payment-method-select" class="block mb-1 text-sm font-semibold text-mono">Select Payment Method</label>
                        <select id="payment-method-select" class="kt-input w-full">
                            <option value="" disabled selected>-- Choose Method --</option>
                            <option value="Cash on Delivery">Cash on Delivery</option>
                            <option value="Stripe">Stripe</option>
                            <option value="Razorpay">Razorpay</option>
                        </select>
                    </div>
                </div>
            </div>
            <!-- Payment Cards -->
            <div class="kt-container-fixed">
                <div class="grid xl:grid-cols-3 gap-5 lg:gap-9 mb-5 lg:mb-10">
                    <!-- Left side cards -->
                    <div class="lg:col-span-2 space-y-5">
                        <div class="grid sm:grid-cols-2 gap-5" id="payment-list">
                            <!-- All your payment cards here -->
                            {% comment %} Your payment cards are already included above {% endcomment %}
                            <!-- Cash on Delivery, Stripe Card, Razorpay Card -->
                            {{ block.super }}
                        </div>
                        <div class="flex justify-end items-center flex-wrap gap-3">
                            <button class="kt-btn kt-btn-outline" data-kt-modal-toggle="#modal_add_payment">Add New Payment Method</button>
                            <a class="kt-btn kt-btn-outline" href="{% url 'dashboard:shipping_info' %}">
                                <i class="ki-filled ki-black-left text-base"></i>
                                Shipping Info
                            </a>
                            <a class="kt-btn kt-btn-primary" href="{% url 'dashboard:order_placed' %}">
                                Place Order
                                <i class="ki-filled ki-mouse-square text-base"></i>
                            </a>
                        </div>
                    </div>
                    <!-- Right side summary -->
                    <div class="lg:col-span-1">
                        <!-- Your order summary block stays here -->
                        {{ block.super }}
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const dropdown = document.getElementById('payment-method-select');
    const paymentList = document.getElementById('payment-list');
    const orderSummaryPayment = document.getElementById('order-summary-payment');

    dropdown.addEventListener('change', function () {
        const value = this.value;
        const cards = paymentList.querySelectorAll('.kt-card');

        cards.forEach(card => {
            const data = card.dataset.payment ? JSON.parse(card.dataset.payment) : {};
            if (data.type === value) {
                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                const selectBtn = card.querySelector('[data-kt-action="select"]');
                if (selectBtn) selectBtn.click();
            }
        });
    });
});
</script>

<script src="https://js.stripe.com/v3/"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const stripe = Stripe("{{ STRIPE_PUBLIC_KEY }}");
    const elements = stripe.elements();
    const card = elements.create("card");
    card.mount("#card-element");

    const form = document.getElementById("stripe-form");
    form.addEventListener("submit", function (event) {
        event.preventDefault();
        stripe.createToken(card).then(function (result) {
            if (result.error) {
                document.getElementById("card-errors").textContent = result.error.message;
            } else {
                const hiddenInput = document.createElement("input");
                hiddenInput.setAttribute("type", "hidden");
                hiddenInput.setAttribute("name", "stripeToken");
                hiddenInput.setAttribute("value", result.token.id);
                form.appendChild(hiddenInput);
                form.submit();
            }
        });
    });
});
</script>
{% endblock content %}
